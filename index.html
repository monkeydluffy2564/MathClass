<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบคลังและติดตามงาน (2568)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- SheetJS library for Excel export/import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Chart.js for Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- html2canvas for JPG Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }
        .table-container {
            max-height: 70vh; /* Limit table height to allow scrolling */
            overflow: auto;
        }
        .table-cell-status {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .table-cell-status:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .square-box {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: auto;
            margin-right: auto;
        }
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        .status-A { background-color: #a7f3d0; color: #065f46; } /* Green */
        .status-B { background-color: #bfdbfe; color: #1e40af; } /* Blue */
        .status-C { background-color: #fef08a; color: #854d0e; } /* Yellow */
        .status-D { background-color: #e9d5ff; color: #581c87; } /* Purple */
        .status-none { background-color: #fecaca; color: #991b1b; } /* Red */
        .status-progress { background-color: #e5e7eb; color: #1f2937; } /* Gray for numeric scores */
        
        .toggle-btn-active { background-color: #4f46e5; color: white; }
        .toggle-btn-inactive { background-color: #d1d5db; color: #4b5563; }

        #assignmentTooltip {
            position: absolute;
            display: none;
            padding: 10px;
            background-color: #333;
            color: white;
            border-radius: 6px;
            z-index: 100;
            pointer-events: none;
        }
        .status-btn-square {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .bulk-grade-btn {
            width: 40px;
            height: 40px;
            font-size: 0.875rem;
        }
        .bulk-grade-btn.selected {
            outline: 2px solid #2563eb;
            outline-offset: 2px;
        }
        .class-tab {
            transition: all 0.2s ease-in-out;
            cursor: grab;
        }
        .class-tab.active {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
        .class-tab.dragging {
            opacity: 0.5;
            background-color: #a5b4fc; /* indigo-300 */
        }
        .editable:hover {
            background-color: #f0f9ff;
            cursor: pointer;
        }
        .collapsible-content {
            max-height: 1000px; /* Or a large enough value */
            transition: max-height 0.5s ease-in-out, margin-top 0.5s ease-in-out, padding 0.5s ease-in-out;
            overflow: hidden;
        }
        .collapsed .collapsible-content {
            max-height: 0;
            margin-top: 0 !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
        }
        .collapsed .collapse-icon {
            transform: rotate(180deg);
        }
        .overdue-header {
            background-color: #fee2e2; /* Light red for overdue assignments */
        }
        .due-soon-header {
            background-color: #fef9c3; /* Light yellow for assignments due soon */
        }
        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: bold;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .toast-notification.show {
            opacity: 1;
        }

        #managementPanel > .flex, 
        #columnPanel > .flex, 
        #statusPanel > .flex {
            transition: margin-bottom 0.5s ease-in-out;
        }

        #managementPanel, #columnPanel, #statusPanel {
            transition: padding-top 0.5s ease-in-out, padding-bottom 0.5s ease-in-out;
        }

        #managementPanel.collapsed,
        #columnPanel.collapsed,
        #statusPanel.collapsed {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }

        #managementPanel.collapsed > .flex,
        #columnPanel.collapsed > .flex,
        #statusPanel.collapsed > .flex {
            margin-bottom: 0;
        }
        /* Sticky header and column styles */
        #gradebookTable thead th {
            position: sticky;
            top: 0;
            z-index: 30; /* Header is above body */
        }
        #gradebookTable tbody td:first-child {
            position: sticky;
            left: 0;
            z-index: 20; /* Sticky column is above other cells but below header */
        }
        #gradebookTable thead th:first-child {
            position: sticky;
            left: 0;
            z-index: 40; /* Top-left corner is on top of everything */
        }
        #totalScoreHeader {
            user-select: none;
        }
        #sortIndicator {
            display: inline-block;
            width: 1em;
            text-align: center;
            font-weight: bold;
        }
        .perfect-submission td:first-child {
            background-color: #e6fffa; /* A light green/teal background */
        }
        .perfect-submission .student-name-cell::after {
            content: '⭐';
            margin-left: 8px;
            color: #f59e0b; /* amber-500 */
        }
        .student-row.dragging-row {
            opacity: 0.4;
            background: #f0f9ff; /* light blue */
        }
        .student-row.drag-over {
            border-top: 2px solid #4f46e5; /* indigo */
        }
        .zero-score {
            color: #ef4444;
            font-weight: 700;
        }
        .gpa-zero-bg {
            background-color: #fee2e2 !important; /* Light red background for GPA 0.0 */
        }
        /* Custom scrollbar for horizontal scrolling tabs on mobile */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Main Container -->
    <div class="w-full p-4 sm:p-6 lg:p-8">
        
        <header class="mb-4 flex flex-col sm:flex-row justify-between items-start gap-4">
            <div>
                <h1 id="mainTitle" class="editable text-2xl sm:text-3xl font-bold text-gray-700 rounded px-2 py-1">ระบบคลังและติดตามงาน</h1>
                <div id="contextHeader" class="flex flex-wrap items-center gap-2 text-gray-500">
                    <!-- Year and Semester selectors will be rendered here -->
                </div>
            </div>
            <div id="topRightButtons" class="flex items-center gap-2 self-end sm:self-center">
                <button id="undoBtn" class="p-2 rounded-full hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed" title="ย้อนกลับ (Undo)">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="currentColor" viewBox="0 0 24 24"><path d="M12.5 8C9.81 8 7.45 8.99 5.6 10.6L2 7V16H11L7.38 12.38C8.77 11.22 10.54 10.5 12.5 10.5C16.04 10.5 19.05 12.81 20.1 16L22.47 15.22C21.07 11.03 17.15 8 12.5 8Z"/></svg>
                </button>
                <button id="redoBtn" class="p-2 rounded-full hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed" title="ทำซ้ำ (Redo)">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="currentColor" viewBox="0 0 24 24"><path d="M18.4 10.6C16.55 8.99 14.19 8 11.5 8C6.85 8 2.93 11.03 1.53 15.22L3.9 16C4.95 12.81 7.96 10.5 11.5 10.5C13.46 10.5 15.23 11.22 16.62 12.38L13 16H22V7L18.4 10.6Z"/></svg>
                </button>
                <button id="settingsBtn" class="p-2 rounded-full hover:bg-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
            </div>
        </header>

        <!-- Responsive Layout: Stacks vertically on mobile, horizontally on larger screens -->
        <div class="mb-6 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
            <!-- Horizontal Scrolling on Mobile -->
            <div id="classTabsContainer" class="flex items-center gap-2 overflow-x-auto whitespace-nowrap pb-2 no-scrollbar">
                <!-- Class tabs will be rendered here -->
            </div>
            <div id="quickActionsContainer" class="flex gap-2 w-full sm:w-auto">
                 <button id="dashboardBtn" class="flex-1 sm:flex-none bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow">ภาพรวม</button>
                 <button id="addAssignmentBtn" class="flex-1 sm:flex-none bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow">เพิ่มงาน</button>
                 <button id="viewSummaryBtn" class="flex-1 sm:flex-none bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow">ดูสรุปงาน</button>
            </div>
        </div>

        <!-- Search Bar -->
        <div id="searchBarContainer" class="mb-4">
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                    </svg>
                </div>
                <input type="text" id="searchInput" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="ค้นหา...">
            </div>
        </div>

        <!-- Main Content Area -->
        <div id="mainContent">
            <div id="gradebookView">
                <div class="table-container bg-white rounded-lg shadow-md mb-6">
                    <table id="gradebookTable" class="text-sm text-left text-gray-600 w-full"></table>
                </div>
            </div>
            <div id="dashboardView" class="hidden">
                 <div id="dashboardContent" class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start mb-6">
                        <h2 id="dashboardTitle" class="text-2xl font-bold text-gray-800">สรุปผลภาพรวม</h2>
                        <button id="exportDashboardBtn" class="mt-4 sm:mt-0 bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors flex items-center justify-center shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Export JPG
                        </button>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Chart 1: Submission Overview -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-semibold mb-2 text-center">ภาพรวมการส่งงาน</h3>
                            <div class="w-full max-w-xs mx-auto">
                                <canvas id="submissionChart"></canvas>
                            </div>
                        </div>
                        <!-- Chart 2: Assignment Performance -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-semibold mb-2 text-center">อัตราการส่งแต่ละงาน</h3>
                            <canvas id="performanceChart"></canvas>
                        </div>
                        <!-- Students at Risk -->
                        <div class="bg-red-50 p-4 rounded-lg">
                            <h3 class="font-semibold text-red-800 mb-2">🔴 นักเรียนที่ต้องดูแลเป็นพิเศษ (ค้างงาน > 50%)</h3>
                            <ul id="studentsAtRiskList" class="list-disc list-inside text-red-700"></ul>
                        </div>
                        <!-- Top Performers -->
                        <div class="bg-green-50 p-4 rounded-lg">
                             <h3 class="font-semibold text-green-800 mb-2">⭐ นักเรียนดีเด่น (ส่งงานครบ/เกือบครบ)</h3>
                            <ul id="topPerformersList" class="list-disc list-inside text-green-700"></ul>
                        </div>
                    </div>
                </div>
            </div>
            <div id="studentReportView" class="hidden">
                <!-- This div will be populated by renderStudentReport -->
            </div>
            <div id="warehouseView" class="hidden">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">คลังนักเรียนติด 0</h2>
                        <div id="warehouseToggle" class="flex rounded-lg bg-gray-200 p-1">
                            <button id="toggleFailed" class="px-3 py-1 text-sm font-semibold rounded-md">ยังไม่แก้</button>
                            <button id="toggleResolved" class="px-3 py-1 text-sm font-semibold rounded-md">แก้แล้ว</button>
                        </div>
                    </div>
                    <div id="warehouseTableContainer">
                        <!-- Warehouse tables will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    
    </div>

    <!-- Modals -->
    <div id="settingsModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-4xl p-6 transform -translate-y-10">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold">ตั้งค่า</h3>
                <button id="closeSettingsModalBtn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div class="max-h-[70vh] overflow-y-auto pr-4">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div id="managementPanel" class="bg-gray-50 p-3 rounded-lg shadow-inner">
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="text-md font-semibold">เครื่องมือจัดการ (ภาคเรียนปัจจุบัน):</h2>
                            <button class="collapse-btn p-1 rounded-full hover:bg-gray-200">
                                <svg class="collapse-icon w-5 h-5 text-gray-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                        </div>
                        <div class="collapsible-content pt-2">
                            <div class="flex flex-wrap gap-3 items-center">
                                <button id="addStudentBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow">เพิ่มนักเรียน</button>
                                <button id="addSpecialColumnBtn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg shadow">เพิ่มคอลัมน์พิเศษ</button>
                            </div>
                            <div class="mt-4 border-t pt-3">
                                <h3 class="text-sm font-semibold mb-2">จัดการห้องเรียน:</h3>
                                <div class="flex flex-wrap gap-3 items-center">
                                    <button id="deleteClassBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow disabled:opacity-50 disabled:cursor-not-allowed">ลบห้องเรียนปัจจุบัน</button>
                                </div>
                            </div>
                            <div class="mt-4 border-t pt-3">
                                <h3 class="text-sm font-semibold mb-2">ตั้งค่าห้องเรียนปัจจุบัน:</h3>
                                <div class="flex items-center">
                                    <input type="checkbox" id="linkSemestersCheckbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <label for="linkSemestersCheckbox" class="ml-2 text-sm text-gray-900">เชื่อมโยงภาคเรียน 1 และ 2 (สำหรับห้องนี้)</label>
                                </div>
                            </div>
                             <div class="mt-4 border-t pt-3">
                                <h3 class="text-sm font-semibold mb-2">นำเข้า/ส่งออก:</h3>
                                <div class="flex flex-wrap gap-3 items-center">
                                    <button id="exportBtn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg shadow">Export (สำรองข้อมูล)</button>
                                    <button id="importBtn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg shadow">Import (กู้ข้อมูล)</button>
                                    <input type="file" id="importFile" class="hidden" accept=".xlsx, .xls">
                                    <button id="customImportBtn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg shadow">Import (ข้อมูลดิบ)</button>
                                    <input type="file" id="customImportFile" class="hidden" accept=".xlsx, .xls">
                                </div>
                            </div>
                             <div class="mt-4 border-t pt-3">
                                <h3 class="text-sm font-semibold mb-2">ตั้งค่าคะแนนเต็ม (สำหรับห้องนี้):</h3>
                                <div class="flex items-center gap-4">
                                    <label for="assignmentScoreInput" class="font-medium">คะแนนเก็บ:</label>
                                    <input type="number" id="assignmentScoreInput" class="w-20 border border-gray-300 rounded-lg p-1 text-center">
                                </div>
                            </div>
                            <div class="mt-4 border-t pt-3">
                                 <button id="clearDataBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow w-full">ล้างข้อมูลทั้งหมดในห้องนี้</button>
                            </div>
                        </div>
                    </div>
                    <div id="columnPanel" class="bg-gray-50 p-3 rounded-lg shadow-inner">
                         <div class="flex justify-between items-center mb-2">
                            <h2 class="text-md font-semibold">จัดการคอลัมน์:</h2>
                            <button class="collapse-btn p-1 rounded-full hover:bg-gray-200">
                                 <svg class="collapse-icon w-5 h-5 text-gray-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                        </div>
                        <div id="columnToggleContainer" class="collapsible-content pt-2 flex flex-wrap gap-2 items-center">
                            <button data-column="assignmentScore" class="toggle-column-btn text-sm font-bold py-2 px-3 rounded-lg shadow">คะแนนเก็บ</button>
                            <button data-column="midterm" class="toggle-column-btn text-sm font-bold py-2 px-3 rounded-lg shadow">กลางภาค</button>
                            <button data-column="final" class="toggle-column-btn text-sm font-bold py-2 px-3 rounded-lg shadow">ปลายภาค</button>
                            <button data-column="midYear" class="toggle-column-btn text-sm font-bold py-2 px-3 rounded-lg shadow">กลางปี</button>
                            <button data-column="yearEnd" class="toggle-column-btn text-sm font-bold py-2 px-3 rounded-lg shadow">ปลายปี</button>
                            <button data-column="totalScore" class="toggle-column-btn text-sm font-bold py-2 px-3 rounded-lg shadow">รวม</button>
                            <button data-column="gpa" class="toggle-column-btn text-sm font-bold py-2 px-3 rounded-lg shadow">ผลการเรียน</button>
                        </div>
                        <div class="mt-4 border-t pt-3">
                            <h3 class="text-sm font-semibold mb-2">การจัดเรียงงาน (แนวนอน):</h3>
                            <div class="flex flex-wrap gap-2">
                                <button id="sortAssignmentsDefault" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-1 px-2 rounded">ตามลำดับเดิม</button>
                                <button id="sortAssignmentsAsc" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-1 px-2 rounded">ส่งน้อย > มาก</button>
                                <button id="sortAssignmentsDesc" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-1 px-2 rounded">ส่งมาก > น้อย</button>
                            </div>
                        </div>
                    </div>
                     <div id="statusPanel" class="bg-gray-50 p-3 rounded-lg shadow-inner lg:col-span-2">
                         <div class="flex justify-between items-center mb-2">
                            <h3 class="font-semibold text-md">คำอธิบายสถานะการส่งงาน:</h3>
                            <button class="collapse-btn p-1 rounded-full hover:bg-gray-200">
                                 <svg class="collapse-icon w-5 h-5 text-gray-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                        </div>
                        <div class="collapsible-content pt-2 flex flex-wrap gap-4 text-sm">
                            <span class="font-semibold status-A px-2 py-1 rounded-md">A: ส่งตรงเวลาและถูกต้อง</span>
                            <span class="font-semibold status-B px-2 py-1 rounded-md">B: ส่งตรงเวลาแต่ไม่ถูกต้อง</span>
                            <span class="font-semibold status-C px-2 py-1 rounded-md">C: ส่งช้าแต่ถูกต้อง</span>
                            <span class="font-semibold status-D px-2 py-1 rounded-md">D: ส่งช้าและไม่ถูกต้อง</span>
                            <span class="font-semibold status-none px-2 py-1 rounded-md">ยังไม่ส่ง</span>
                        </div>
                    </div>
                    <div id="yearManagementPanel" class="bg-blue-50 p-3 rounded-lg shadow-inner lg:col-span-2">
                        <h2 class="text-md font-semibold mb-2">จัดการปีการศึกษา:</h2>
                        <div class="flex flex-wrap gap-3 items-center">
                            <button id="addYearBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow">เพิ่มปีการศึกษา</button>
                            <button id="addSemesterBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow">เพิ่มภาคเรียน</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="assignmentTooltip"></div>
    <div id="gradeModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-sm p-6 transform -translate-y-10">
            <h3 class="text-xl font-bold mb-2">แก้ไขสถานะการส่งงาน</h3>
            <p>นักเรียน: <span id="modalStudentName" class="font-semibold"></span></p>
            <p class="mb-4">งาน: <span id="modalAssignmentName" class="font-semibold"></span></p>
            <div class="flex flex-wrap justify-center gap-2">
                <button data-status="A" class="status-btn status-btn-square status-A text-lg font-bold rounded-lg shadow">A</button>
                <button data-status="B" class="status-btn status-btn-square status-B text-lg font-bold rounded-lg shadow">B</button>
                <button data-status="C" class="status-btn status-btn-square status-C text-lg font-bold rounded-lg shadow">C</button>
                <button data-status="D" class="status-btn status-btn-square status-D text-lg font-bold rounded-lg shadow">D</button>
                <button data-status="none" class="status-btn status-btn-square status-none text-xs font-bold rounded-lg shadow">ยังไม่ส่ง</button>
            </div>
            <div class="mt-4 border-t pt-4">
                <label for="modalProgressScore" class="block text-sm font-medium text-gray-700">คะแนนความก้าวหน้า (ไม่คิดเกรด)</label>
                <input type="number" id="modalProgressScore" class="mt-1 w-full text-center border-gray-300 rounded-lg p-2 shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div class="mt-6 text-right"><button id="closeGradeModalBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">ปิด</button></div>
        </div>
    </div>
    <div id="inputModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md p-6 transform -translate-y-10">
            <h3 id="inputModalTitle" class="text-xl font-bold mb-2"></h3>
            <p id="inputModalDesc" class="mb-4 text-gray-600"></p>
            <input type="text" id="inputModalField" class="w-full border border-gray-300 rounded-lg p-2 mb-4">
            <textarea id="inputModalTextarea" class="w-full border border-gray-300 rounded-lg p-2 mb-4" rows="5"></textarea>
            <div class="flex justify-end gap-3">
                <button id="inputModalCancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">ยกเลิก</button>
                <button id="inputModalConfirmBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">ยืนยัน</button>
            </div>
        </div>
    </div>
    <div id="assignmentModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg p-6 transform -translate-y-10">
            <h3 id="assignmentModalTitle" class="text-xl font-bold mb-4"></h3>
            <form id="assignmentForm" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="sm:col-span-2"><label for="assignmentName" class="block mb-1 font-semibold">ชื่องาน</label><input type="text" id="assignmentName" class="w-full border rounded-lg p-2" required></div>
                <div><label for="assignmentChapter" class="block mb-1 font-semibold">บทที่</label><input type="text" id="assignmentChapter" class="w-full border rounded-lg p-2"></div>
                <div><label for="assignmentDate" class="block mb-1 font-semibold">วันที่มอบหมาย</label><input type="text" id="assignmentDate" class="w-full border rounded-lg p-2" placeholder="วว/ดด/ปปปป"></div>
                <div><label for="daysToSubmit" class="block mb-1 font-semibold">กำหนดส่ง (วัน)</label><input type="number" id="daysToSubmit" class="w-full border rounded-lg p-2" value="7"></div>
                <div><label for="assignmentQuantity" class="block mb-1 font-semibold">จำนวน</label><input type="number" id="assignmentQuantity" class="w-full border rounded-lg p-2"></div>
                <div><label for="assignmentPage" class="block mb-1 font-semibold">หน้า</label><input type="text" id="assignmentPage" class="w-full border rounded-lg p-2"></div>
                <div><label for="assignmentWeight" class="block mb-1 font-semibold">น้ำหนักคะแนน</label><input type="number" id="assignmentWeight" class="w-full border rounded-lg p-2" value="1" min="0" step="0.1"></div>
            </form>
            <div class="flex justify-end gap-3 mt-6">
                <button id="assignmentModalCancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">ยกเลิก</button>
                <button id="assignmentModalConfirmBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">บันทึก</button>
            </div>
        </div>
    </div>
    <div id="summaryModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-5xl p-6 transform -translate-y-10">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">สรุปรายการงานทั้งหมด</h3>
                <button id="closeSummaryModalBtn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div class="max-h-[70vh] overflow-y-auto">
                <table class="w-full text-sm text-left text-gray-600">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-2">ที่</th><th class="px-4 py-2">บทที่</th><th class="px-4 py-2 w-1/2">ชื่องาน</th>
                            <th class="px-4 py-2 text-center">น้ำหนัก</th><th class="px-4 py-2 text-center">จำนวน</th><th class="px-4 py-2 text-center">หน้า</th><th class="px-4 py-2">วันที่มอบหมาย</th><th class="px-4 py-2">กำหนดส่ง</th><th class="px-4 py-2 text-center">สถานะ</th>
                        </tr>
                    </thead>
                    <tbody id="summaryTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="bulkGradeModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 transform -translate-y-10">
            <div class="flex justify-between items-start mb-4">
                <h3 id="bulkGradeModalTitle" class="text-xl font-bold">ให้คะแนนงาน</h3>
                <div class="flex items-center">
                    <input type="checkbox" id="bulkGradeFilter" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked>
                    <label for="bulkGradeFilter" class="ml-2 block text-sm text-gray-900">แสดงเฉพาะที่ยังไม่ส่ง</label>
                </div>
            </div>
            <div id="bulkGradeTableBody" class="max-h-[70vh] overflow-y-auto">
                <!-- Content will be rendered here -->
            </div>
            <div class="mt-6 text-right"><button id="closeBulkGradeModalBtn" class="bg-gray-300 hover:bg-gray-400 font-bold py-2 px-4 rounded-lg">ปิด</button></div>
        </div>
    </div>
    <div id="studentGradeModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 transform -translate-y-10">
             <div class="flex justify-between items-start mb-4">
                <h3 id="studentGradeModalTitle" class="text-xl font-bold">ให้คะแนนนักเรียน</h3>
                <div class="flex items-center">
                    <input type="checkbox" id="studentGradeFilter" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked>
                    <label for="studentGradeFilter" class="ml-2 block text-sm text-gray-900">แสดงเฉพาะที่ยังไม่ส่ง</label>
                </div>
            </div>
            <div id="studentGradeTableBody" class="max-h-[70vh] overflow-y-auto">
                <!-- Content will be rendered here -->
            </div>
            <div class="mt-6 flex justify-between items-center">
                <button id="viewStudentReportBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow">รายงานผลนักเรียนรายบุคคล</button>
                <button id="closeStudentGradeModalBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">ปิด</button>
            </div>
        </div>
    </div>
    <div id="failedStudentDetailModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-4xl p-6 transform -translate-y-10">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">รายละเอียดผลการเรียน</h3>
                <button id="closeFailedStudentDetailModalBtn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="failedStudentDetailContent" class="max-h-[70vh] overflow-y-auto">
                <!-- Content will be rendered here -->
            </div>
        </div>
    </div>


<script type="module">
    // --- Firebase SDK Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    document.addEventListener('DOMContentLoaded', async () => {
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyB_DjUyANiQMWnFSG7d71R_ANviYbrUMM8",
            authDomain: "grading-system-a666b.firebaseapp.com",
            projectId: "grading-system-a666b",
            storageBucket: "grading-system-a666b.appspot.com",
            messagingSenderId: "1008723501468",
            appId: "1:1008723501468:web:d9736312e4f1da107ca859",
            measurementId: "G-JSHX5M64R0"
        };

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setLogLevel('debug'); // For detailed logs
        await signInAnonymously(auth);
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-public-gradebook-v2';
        const gradebookDocRef = doc(db, "artifacts", appId, "public", "data", "gradebook", "main");

        // --- CONFIGURATION ---
        const GRADE_MULTIPLIER = { 'A': 1.0, 'B': 0.9, 'C': 0.9, 'D': 0.8, 'none': 0 };
        const GRADE_SCORE_MAP = { 'A': 4, 'B': 3, 'C': 2, 'D': 1, 'none': 0 };


        // --- DOM ELEMENTS ---
        const allModals = document.querySelectorAll('.modal');
        const gradebookTable = document.getElementById('gradebookTable');
        const addStudentBtn = document.getElementById('addStudentBtn');
        const addAssignmentBtn = document.getElementById('addAssignmentBtn');
        const addSpecialColumnBtn = document.getElementById('addSpecialColumnBtn');
        const viewSummaryBtn = document.getElementById('viewSummaryBtn');
        const clearDataBtn = document.getElementById('clearDataBtn');
        const assignmentTooltip = document.getElementById('assignmentTooltip');
        const assignmentScoreInput = document.getElementById('assignmentScoreInput');
        const classTabsContainer = document.getElementById('classTabsContainer');
        const mainTitle = document.getElementById('mainTitle');
        const contextHeader = document.getElementById('contextHeader');
        const exportBtn = document.getElementById('exportBtn');
        const importBtn = document.getElementById('importBtn');
        const importFile = document.getElementById('importFile');
        const customImportBtn = document.getElementById('customImportBtn');
        const customImportFile = document.getElementById('customImportFile');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const undoBtn = document.getElementById('undoBtn');
        const redoBtn = document.getElementById('redoBtn');
        const deleteClassBtn = document.getElementById('deleteClassBtn');
        const dashboardBtn = document.getElementById('dashboardBtn');
        const gradebookView = document.getElementById('gradebookView');
        const dashboardView = document.getElementById('dashboardView');
        const studentReportView = document.getElementById('studentReportView');
        const warehouseView = document.getElementById('warehouseView');
        const exportDashboardBtn = document.getElementById('exportDashboardBtn');
        const searchInput = document.getElementById('searchInput');
        
        // --- APP STATE ---
        let state = {};
        let onInputConfirm = null;
        let onAssignmentConfirm = null;
        let currentInputType = 'input';
        let currentEdit = { studentId: null, assignmentId: null };
        let draggedTab = null;
        let draggedStudentId = null;
        let currentView = 'gradebook'; // 'gradebook', 'dashboard', 'studentReport', 'warehouse'
        let currentWarehouseView = 'failed'; // 'failed', 'resolved'
        let submissionChartInstance = null;
        let performanceChartInstance = null;
        let studentDevChartInstance = null;


        // --- HISTORY MANAGEMENT (Undo/Redo) ---
        let historyStack = [];
        let historyIndex = -1;
        let isTimeTraveling = false; // Prevents feedback loop during undo/redo

        // --- INITIAL DATA & STATE MANAGEMENT ---
        const getNewClassData = () => ({
            students: [], assignments: [], specialColumns: [],
            grades: {}, examScores: {}, specialScores: {}, progressScores: {},
            scoreConfig: { assignment: 50, midterm: 20, final: 30, midYear: 0, yearEnd: 0 },
            columnVisibility: { assignmentScore: true, midterm: true, final: true, midYear: true, yearEnd: true, totalScore: true, gpa: true },
            settings: { linkSemesters: false } // NEW: Per-class setting
        });
        
        const getNewSemesterData = (name) => ({
            id: `${Date.now()}-${Math.random()}`, // Add random number to ensure uniqueness
            name: name,
            classes: [{ id: 1, name: 'ม.1/1' }],
            currentClassId: 1,
            classData: { '1': getNewClassData() },
        });

        const getNewYearData = (year) => ({
            year: year,
            semesters: [getNewSemesterData('ภาคเรียนที่ 1'), getNewSemesterData('ภาคเรียนที่ 2')]
            // Removed global link setting
        });

        const getInitialState = () => {
            const currentThaiYear = new Date().getFullYear() + 543;
            return {
                mainTitle: 'ระบบคลังและติดตามงาน',
                academicYears: [getNewYearData(currentThaiYear)],
                currentAcademicYear: currentThaiYear,
                currentSemesterId: null, // Will be set after init
                failedStudentWarehouse: {},
                resolvedFailedStudents: {}, // NEW: For students who have been resolved
                panelVisibility: { managementPanel: true, columnPanel: true, statusPanel: true },
                sortConfig: { studentSort: 'default', assignmentSort: 'default' },
                currentStudentIdForReport: null,
                warehouseDetailShowAll: false // NEW for warehouse detail filter
            };
        };

        const saveStateToFirebase = async () => {
            if (isTimeTraveling) return; 
            try {
                if (!state.failedStudentWarehouse) state.failedStudentWarehouse = {};
                if (!state.resolvedFailedStudents) state.resolvedFailedStudents = {}; // NEW
                await setDoc(gradebookDocRef, state);
            } catch (error) {
                console.error("Error saving state to Firebase:", error);
            }
        };

        const commitChange = (mutator) => {
            if (isTimeTraveling) {
                mutator();
                render();
                return;
            }
            if (historyIndex < historyStack.length - 1) {
                historyStack = historyStack.slice(0, historyIndex + 1);
            }
            historyStack.push(JSON.parse(JSON.stringify(state)));
            historyIndex = historyStack.length - 1;
            
            mutator();
            
            updateFailedStudentWarehouse(); 
            saveStateToFirebase();
            render();
            updateUndoRedoButtons();
        };
        
        const migrateOldState = (oldState) => {
            console.log("Migrating old data structure to new version...");
            const newInitialState = getInitialState();
            const year = newInitialState.academicYears[0];
            const semester = year.semesters[0];

            semester.classes = oldState.classes || [{ id: 1, name: 'ม.1/1' }];
            semester.currentClassId = oldState.currentClassId || 1;
            semester.classData = oldState.classData || { '1': getNewClassData() };

            // Add new settings object to each class during migration
            Object.values(semester.classData).forEach(classData => {
                if (!classData.settings) {
                    classData.settings = { linkSemesters: false };
                }
            });

            newInitialState.mainTitle = oldState.mainTitle || 'ระบบคลังและติดตามงาน';
            newInitialState.currentSemesterId = semester.id;
            
            return newInitialState;
        };

        const setupFirestoreListener = () => {
            onSnapshot(gradebookDocRef, (docSnap) => {
                // --- Start of Fix: Preserve scroll position during live updates ---
                // บันทึกตำแหน่งการสกรอลล์ปัจจุบันของตารางในคลังข้อมูลก่อนที่จะมีการ re-render
                const warehouseContainer = document.getElementById('warehouseTableContainer');
                const scrollableWarehouseDiv = warehouseContainer ? warehouseContainer.querySelector('div[class*="overflow-auto"]') : null;
                const warehouseScrollTop = scrollableWarehouseDiv ? scrollableWarehouseDiv.scrollTop : 0;
                // --- End of Fix ---

                isTimeTraveling = true; 
                if (docSnap.exists()) {
                    let loadedState = docSnap.data();
                    if (!loadedState.academicYears) {
                        state = migrateOldState(loadedState);
                        saveStateToFirebase();
                    } else {
                        state = loadedState;
                    }
                    
                    // --- Data Integrity Checks ---
                    if (!state.mainTitle) state.mainTitle = 'ระบบคลังและติดตามงาน';
                    if (!state.panelVisibility) state.panelVisibility = { managementPanel: true, columnPanel: true, statusPanel: true };
                    if (!state.sortConfig) state.sortConfig = { studentSort: 'default', assignmentSort: 'default' };
                    if (!state.failedStudentWarehouse) state.failedStudentWarehouse = {};
                    if (!state.resolvedFailedStudents) state.resolvedFailedStudents = {}; // NEW
                    if (state.currentStudentIdForReport === undefined) state.currentStudentIdForReport = null;
                    if (state.warehouseDetailShowAll === undefined) state.warehouseDetailShowAll = false; // NEW
                    
                    let currentYearData = state.academicYears.find(y => y.year === state.currentAcademicYear);
                    if (!currentYearData) {
                        state.currentAcademicYear = state.academicYears[0].year;
                        currentYearData = state.academicYears[0];
                    }
                    const currentSemesterData = currentYearData.semesters.find(s => s.id === state.currentSemesterId);
                    if (!currentSemesterData) {
                        state.currentSemesterId = currentYearData.semesters[0].id;
                    }
                    
                    // Integrity check for per-class settings
                    state.academicYears.forEach(year => {
                        year.semesters.forEach(semester => {
                            Object.values(semester.classData).forEach(classData => {
                                if (!classData.settings) {
                                    classData.settings = { linkSemesters: false };
                                }
                            });
                        });
                    });

                } else {
                    console.log("No document found! Creating a new one.");
                    state = getInitialState();
                    state.currentSemesterId = state.academicYears[0].semesters[0].id;
                    saveStateToFirebase();
                }

                if (historyStack.length === 0) {
                     historyStack.push(JSON.parse(JSON.stringify(state)));
                     historyIndex = 0;
                }
                
                render();

                // --- Start of Fix: Restore scroll position after render ---
                // หากมุมมองปัจจุบันคือคลังข้อมูล ให้คืนค่าตำแหน่งการสกรอลล์กลับไปที่เดิม
                if (currentView === 'warehouse' && warehouseScrollTop > 0) {
                    const newScrollableWarehouseDiv = warehouseContainer ? warehouseContainer.querySelector('div[class*="overflow-auto"]') : null;
                    if (newScrollableWarehouseDiv) {
                        newScrollableWarehouseDiv.scrollTop = warehouseScrollTop;
                    }
                }
                // --- End of Fix ---

                updateUndoRedoButtons();
                isTimeTraveling = false;
            }, (error) => {
                console.error("Error listening to Firestore:", error);
            });
        };
        
        // --- DATA ACCESS HELPERS ---
        const getCurrentAcademicYearData = () => state.academicYears ? state.academicYears.find(y => y.year === state.currentAcademicYear) : null;
        const getCurrentSemesterData = () => {
            const yearData = getCurrentAcademicYearData();
            return yearData ? yearData.semesters.find(s => s.id === state.currentSemesterId) : null;
        };
        const getCurrentClassData = () => {
            const semesterData = getCurrentSemesterData();
            return semesterData ? semesterData.classData[semesterData.currentClassId] : null;
        };

        // --- DATE UTILITIES ---
        const parseDate = (dateStr) => { 
            if (!dateStr || typeof dateStr !== 'string') return null;
            const parts = dateStr.split('/');
            if (parts.length !== 3) return null;
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1;
            let year = parseInt(parts[2], 10);
            if (year > 2500) year -= 543;
            return new Date(year, month, day);
        };

        const formatDate = (date) => {
            if (!(date instanceof Date) || isNaN(date)) return '';
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear() + 543;
            return `${day}/${month}/${year}`;
        };

        const getDueDate = (assignment) => {
            const assignedDate = parseDate(assignment.assignedDate);
            if (!assignedDate) return null;
            const dueDate = new Date(assignedDate);
            dueDate.setDate(dueDate.getDate() + (assignment.daysToSubmit || 0));
            return dueDate;
        };

        const isOverdue = (assignment) => {
            const dueDate = getDueDate(assignment);
            if (!dueDate) return false;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return dueDate < today;
        };

        // --- CORE LOGIC & CALCULATIONS ---
        const isSubmissionComplete = (studentId) => {
            const classData = getCurrentClassData();
            if (!classData || classData.assignments.length === 0) return false;

            return classData.assignments.every(assignment => {
                const gradeKey = `${studentId}-${assignment.id}`;
                const hasGrade = classData.grades[gradeKey] && classData.grades[gradeKey] !== 'none';
                const hasProgressScore = classData.progressScores &&
                                    classData.progressScores[gradeKey] !== undefined &&
                                    classData.progressScores[gradeKey] !== null &&
                                    classData.progressScores[gradeKey] !== '';
                return hasGrade || hasProgressScore;
            });
        };

        const calculateGpa = (score) => {
            if (score >= 80) return 4.0; if (score >= 75) return 3.5; if (score >= 70) return 3.0;
            if (score >= 65) return 2.5; if (score >= 60) return 2.0; if (score >= 55) return 1.5;
            if (score >= 50) return 1.0; return 0.0;
        };

        const calculateScores = (studentId, specificClassData = null) => {
            const classData = specificClassData || getCurrentClassData();
            if (!classData) return { assignmentScore: 0, totalScore: 0, midterm: 0, final: 0, midYear: 0, yearEnd: 0, gpa: '0.0' };
            
            const assignmentsForGrading = classData.assignments.filter(assignment => {
                return !classData.students.some(student => {
                    const progressScore = classData.progressScores ? classData.progressScores[`${student.id}-${assignment.id}`] : undefined;
                    return progressScore !== undefined && progressScore !== null && progressScore !== '';
                });
            });

            const studentExams = classData.examScores[studentId] || { midterm: 0, final: 0, midYear: 0, yearEnd: 0 };
            
            let totalAssignmentPoints = 0;
            const totalWeight = assignmentsForGrading.reduce((sum, a) => sum + (a.weight || 1), 0);

            if (totalWeight > 0) {
                let studentWeightedScore = 0;
                assignmentsForGrading.forEach(assignment => {
                    const grade = classData.grades[`${studentId}-${assignment.id}`] || 'none';
                    const weight = assignment.weight || 1;
                    studentWeightedScore += GRADE_MULTIPLIER[grade] * weight;
                });
                totalAssignmentPoints = (studentWeightedScore / totalWeight) * (classData.scoreConfig.assignment || 50);
            }

            const roundedAssignmentScore = Math.ceil(totalAssignmentPoints);

            let totalSpecialPoints = 0;
            classData.specialColumns.forEach(col => {
                totalSpecialPoints += classData.specialScores[`${studentId}-${col.id}`] || 0;
            });
            
            const totalScore = roundedAssignmentScore + (studentExams.midterm || 0) + (studentExams.final || 0) + (studentExams.midYear || 0) + (studentExams.yearEnd || 0) + totalSpecialPoints;
            const gpa = calculateGpa(totalScore > 100 ? 100 : totalScore);
            
            return {
                assignmentScore: roundedAssignmentScore,
                totalScore: parseFloat(totalScore.toFixed(2)),
                midterm: studentExams.midterm || 0,
                final: studentExams.final || 0,
                midYear: studentExams.midYear || 0,
                yearEnd: studentExams.yearEnd || 0,
                gpa: gpa.toFixed(1)
            };
        };

        // --- MAIN RENDERING LOGIC ---
        const render = () => {
            if (!state || !state.mainTitle) return;
            mainTitle.textContent = state.mainTitle;
            
            const topRightButtons = document.getElementById('topRightButtons');
            const quickActionsDiv = document.getElementById('quickActionsContainer');
            const searchBarDiv = document.getElementById('searchBarContainer');

            // Hide all views and headers first
            gradebookView.classList.add('hidden');
            dashboardView.classList.add('hidden');
            studentReportView.classList.add('hidden');
            warehouseView.classList.add('hidden');
            classTabsContainer.classList.add('hidden');
            quickActionsDiv.classList.add('hidden');
            searchBarDiv.classList.add('hidden');
            topRightButtons.classList.add('hidden');

            renderContextSelectors(); // This will decide which header to show

            const semesterData = getCurrentSemesterData();
            const hasData = semesterData && semesterData.classes.length > 0;

            if (currentView === 'warehouse') {
                warehouseView.classList.remove('hidden');
                searchBarDiv.classList.remove('hidden');
                searchInput.placeholder = "ค้นหาในคลัง...";
                topRightButtons.classList.remove('hidden');
                topRightButtons.querySelector('#settingsBtn').classList.add('hidden'); // Hide only settings
                renderWarehouseView();
            } else if (currentView === 'studentReport' && hasData) {
                studentReportView.classList.remove('hidden');
                // No top buttons or search bar on individual report
                renderStudentReport(state.currentStudentIdForReport);
            } else if (hasData) {
                // Show all main UI elements
                classTabsContainer.classList.remove('hidden');
                quickActionsDiv.classList.remove('hidden');
                searchBarDiv.classList.remove('hidden');
                topRightButtons.classList.remove('hidden');
                topRightButtons.querySelector('#settingsBtn').classList.remove('hidden');
                searchInput.placeholder = "ค้นหาชื่อนักเรียน...";
                renderClassTabs();

                if (currentView === 'dashboard') {
                    dashboardView.classList.remove('hidden');
                    dashboardBtn.textContent = 'ตารางคะแนน';
                    renderDashboard();
                } else { 
                    gradebookView.classList.remove('hidden');
                    dashboardBtn.textContent = 'ภาพรวม';
                    renderTable();
                }
            } else {
                // No data view
                gradebookView.classList.remove('hidden');
                topRightButtons.classList.remove('hidden'); // Still show settings to add data
                gradebookView.innerHTML = `<div class="text-center p-10 bg-white rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold text-gray-700">ไม่มีข้อมูลสำหรับภาคเรียนนี้</h2>
                    <p class="text-gray-500 mt-2">กรุณาเลือกปีการศึกษาและภาคเรียน หรือไปที่ 'ตั้งค่า' เพื่อเพิ่มข้อมูลใหม่</p>
                </div>`;
            }

            updateToggleButtons();
            updatePanelVisibility();
            const currentClassData = getCurrentClassData();
            if (currentClassData && currentClassData.scoreConfig) {
                assignmentScoreInput.value = currentClassData.scoreConfig.assignment;
            }
            if (deleteClassBtn) {
                deleteClassBtn.disabled = !semesterData || semesterData.classes.length <= 1;
            }
        };

        
        const renderContextSelectors = () => {
            contextHeader.innerHTML = '';

            if (currentView === 'warehouse') {
                const backBtn = document.createElement('button');
                backBtn.id = "backToGradebookBtn";
                backBtn.className = 'bg-gray-500 hover:bg-gray-600 text-white text-sm font-bold py-1.5 px-3 rounded-lg shadow flex items-center';
                backBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    กลับไปหน้าหลัก`;
                backBtn.addEventListener('click', () => {
                    currentView = 'gradebook';
                    render();
                });
                contextHeader.appendChild(backBtn);
                return; 
            }

            // --- Year Selector ---
            const yearWrapper = document.createElement('div');
            yearWrapper.className = 'flex items-center gap-1';
            const yearSelect = document.createElement('select');
            yearSelect.id = 'yearSelector';
            yearSelect.className = 'bg-gray-200 border border-gray-300 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-1.5';
            state.academicYears.forEach(y => {
                const option = document.createElement('option');
                option.value = y.year;
                option.textContent = `ปีการศึกษา ${y.year}`;
                option.selected = y.year === state.currentAcademicYear;
                yearSelect.appendChild(option);
            });
            yearSelect.addEventListener('change', (e) => {
                const newYear = parseInt(e.target.value);
                commitChange(() => {
                    state.currentAcademicYear = newYear;
                    state.currentSemesterId = state.academicYears.find(y => y.year === newYear).semesters[0].id;
                });
            });
            yearWrapper.appendChild(yearSelect);

            const editYearBtn = document.createElement('button');
            editYearBtn.className = 'p-1 rounded-full hover:bg-gray-300';
            editYearBtn.title = "แก้ไขปีการศึกษา";
            editYearBtn.innerHTML = `<svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>`;
            editYearBtn.addEventListener('click', handleEditYear);
            yearWrapper.appendChild(editYearBtn);

            const deleteYearBtn = document.createElement('button');
            deleteYearBtn.className = 'p-1 rounded-full hover:bg-gray-300';
            deleteYearBtn.title = "ลบปีการศึกษา";
            deleteYearBtn.innerHTML = `<svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>`;
            deleteYearBtn.addEventListener('click', handleDeleteYear);
            yearWrapper.appendChild(deleteYearBtn);
            contextHeader.appendChild(yearWrapper);

            // --- Semester Selector ---
            const semesterWrapper = document.createElement('div');
            semesterWrapper.className = 'flex items-center gap-1';
            const semesterSelect = document.createElement('select');
            semesterSelect.id = 'semesterSelector';
            semesterSelect.className = 'bg-gray-200 border border-gray-300 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-1.5';
            const currentYearData = getCurrentAcademicYearData();
            if (currentYearData) {
                currentYearData.semesters.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.id;
                    option.textContent = s.name;
                    semesterSelect.appendChild(option);
                });
                semesterSelect.value = state.currentSemesterId; 
            }
            semesterSelect.addEventListener('change', (e) => {
                const newSemesterId = e.target.value;
                commitChange(() => { state.currentSemesterId = newSemesterId; });
            });
            semesterWrapper.appendChild(semesterSelect);

            const editSemesterBtn = document.createElement('button');
            editSemesterBtn.className = 'p-1 rounded-full hover:bg-gray-300';
            editSemesterBtn.title = "แก้ไขภาคเรียน";
            editSemesterBtn.innerHTML = `<svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>`;
            editSemesterBtn.addEventListener('click', handleEditSemester);
            semesterWrapper.appendChild(editSemesterBtn);

            const deleteSemesterBtn = document.createElement('button');
            deleteSemesterBtn.className = 'p-1 rounded-full hover:bg-gray-300';
            deleteSemesterBtn.title = "ลบภาคเรียน";
            deleteSemesterBtn.innerHTML = `<svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>`;
            deleteSemesterBtn.addEventListener('click', handleDeleteSemester);
            semesterWrapper.appendChild(deleteSemesterBtn);
            contextHeader.appendChild(semesterWrapper);

            // --- Warehouse Button ---
            const warehouseBtn = document.createElement('button');
            warehouseBtn.id = "warehouseBtn";
            warehouseBtn.className = 'bg-red-500 hover:bg-red-600 text-white text-sm font-bold py-1.5 px-3 rounded-lg shadow';
            const warehouseCount = Object.keys(state.failedStudentWarehouse || {}).length;
            warehouseBtn.textContent = `คลังนักเรียนติด 0 (${warehouseCount})`;
            warehouseBtn.addEventListener('click', () => {
                currentView = 'warehouse';
                render();
            });
            contextHeader.appendChild(warehouseBtn);
        };
        
        const updateUndoRedoButtons = () => {
            undoBtn.disabled = historyIndex <= 0;
            redoBtn.disabled = historyIndex >= historyStack.length - 1;
        };
        
        const updatePanelVisibility = () => {
            for (const panelId in state.panelVisibility) {
                const panel = document.getElementById(panelId);
                if (panel) {
                    panel.classList.toggle('collapsed', !state.panelVisibility[panelId]);
                }
            }
            const classData = getCurrentClassData();
            const linkCheckbox = document.getElementById('linkSemestersCheckbox');
            if (classData && linkCheckbox) {
                linkCheckbox.checked = classData.settings.linkSemesters;
            }
        };

        const renderClassTabs = () => {
            classTabsContainer.innerHTML = '';
            const semesterData = getCurrentSemesterData();
            if (!semesterData) return;

            semesterData.classes.forEach(cls => {
                const tab = document.createElement('button');
                tab.className = `class-tab px-4 py-2 text-sm font-semibold border-b-2 rounded-t-lg`;
                tab.textContent = cls.name;
                tab.draggable = true;
                tab.dataset.classId = cls.id;
                tab.classList.toggle('active', cls.id === semesterData.currentClassId);
                tab.classList.toggle('border-indigo-500', cls.id === semesterData.currentClassId);
                tab.classList.toggle('text-gray-500', cls.id !== semesterData.currentClassId);
                tab.classList.toggle('hover:bg-gray-100', cls.id !== semesterData.currentClassId);
                tab.classList.toggle('border-transparent', cls.id !== semesterData.currentClassId);
                tab.addEventListener('click', () => handleSwitchClass(cls.id));
                addEditListeners(tab, () => handleEditClassName(cls.id, cls.name));
                tab.addEventListener('dragstart', handleDragStart);
                tab.addEventListener('dragover', handleDragOver);
                tab.addEventListener('drop', handleDrop);
                tab.addEventListener('dragend', handleDragEnd);
                classTabsContainer.appendChild(tab);
            });
            const addClassBtn = document.createElement('button');
            addClassBtn.id = 'addClassBtn';
            addClassBtn.className = 'ml-2 bg-gray-200 hover:bg-gray-300 text-gray-600 font-bold w-8 h-8 rounded-full flex items-center justify-center';
            addClassBtn.textContent = '+';
            addClassBtn.addEventListener('click', handleAddClass);
            classTabsContainer.appendChild(addClassBtn);
        };

        const renderTable = () => {
            gradebookTable.innerHTML = '';
            const classData = getCurrentClassData();
            if (!classData) return;

            const yearData = getCurrentAcademicYearData();
            const semesterData = getCurrentSemesterData();
            const isLinkedAndSecondSemester = classData.settings.linkSemesters && yearData.semesters.length >= 2 && semesterData.id === yearData.semesters[1].id;

            let sortedStudents = [...classData.students];
            const studentSortOrder = state.sortConfig.studentSort;
            if (studentSortOrder !== 'default') {
                sortedStudents.sort((a, b) => {
                    const scoreA = calculateScores(a.id).totalScore;
                    const scoreB = calculateScores(b.id).totalScore;
                    return studentSortOrder === 'asc' ? scoreA - scoreB : scoreB - scoreA;
                });
            }

            let sortedAssignments = [...classData.assignments];
            if (state.sortConfig.assignmentSort !== 'default') {
                sortedAssignments.sort((a, b) => {
                    const countA = classData.students.filter(s => classData.grades[`${s.id}-${a.id}`] || (classData.progressScores && classData.progressScores[`${s.id}-${a.id}`])).length;
                    const countB = classData.students.filter(s => classData.grades[`${s.id}-${b.id}`] || (classData.progressScores && classData.progressScores[`${s.id}-${b.id}`])).length;
                    return state.sortConfig.assignmentSort === 'asc' ? countA - countB : countB - countA;
                });
            }


            const { assignmentScore, midterm, final, midYear, yearEnd, totalScore, gpa } = classData.columnVisibility;
            const thead = document.createElement('thead');
            thead.className = "text-xs text-gray-700 uppercase";
            let headerRow = '<tr>';
            headerRow += '<th class="px-2 py-2 bg-gray-50 align-middle whitespace-nowrap">ชื่อ - สกุล</th>';
            if (assignmentScore) headerRow += '<th class="px-2 py-2 text-center align-middle whitespace-nowrap bg-gray-50">คะแนนเก็บ</th>';
            if (midterm) headerRow += '<th class="px-2 py-2 text-center align-middle whitespace-nowrap bg-gray-50">กลางภาค</th>';
            if (final) headerRow += '<th class="px-2 py-2 text-center align-middle whitespace-nowrap bg-gray-50">ปลายภาค</th>';
            if (midYear) headerRow += '<th class="px-2 py-2 text-center align-middle whitespace-nowrap bg-gray-50">กลางปี</th>';
            if (yearEnd) headerRow += '<th class="px-2 py-2 text-center align-middle whitespace-nowrap bg-gray-50">ปลายปี</th>';
            classData.specialColumns.forEach(col => {
                if (classData.columnVisibility[`special-${col.id}`]) {
                    headerRow += `<th class="px-2 py-2 text-center align-middle whitespace-nowrap bg-gray-50">${col.name}</th>`;
                }
            });
            if (totalScore) {
                 headerRow += `<th id="totalScoreHeader" class="px-2 py-2 text-center align-middle whitespace-nowrap bg-gray-50 cursor-pointer" title="คลิกเพื่อเรียงคะแนน">
                    <span>รวม</span><span id="sortIndicator"></span>
                </th>`;
            }
            if (gpa) headerRow += '<th class="px-2 py-2 text-center align-middle whitespace-nowrap bg-gray-50">ผลการเรียน</th>';
            if (isLinkedAndSecondSemester && gpa) {
                headerRow += '<th class="px-2 py-2 text-center align-middle whitespace-nowrap bg-blue-50">ผลการเรียนเฉลี่ย</th>';
            }
            sortedAssignments.forEach((a, index) => { 
                const originalIndex = classData.assignments.findIndex(orig => orig.id === a.id);
                let bgClass = 'bg-gray-50';
                if (isOverdue(a)) {
                    bgClass = 'overdue-header';
                }
                headerRow += `<th class="assignment-header p-1 text-center align-middle cursor-pointer ${bgClass}" data-assignment-id="${a.id}">
                    <div class="square-box"><span>${originalIndex + 1}</span></div></th>`; 
            });
            headerRow += '<th class="px-2 py-2 text-center align-middle bg-gray-50">จัดการ</th></tr>';
            thead.innerHTML = headerRow;
            gradebookTable.appendChild(thead);

            const tbody = document.createElement('tbody');
            sortedStudents.forEach(student => {
                const scores = calculateScores(student.id);
                const isComplete = isSubmissionComplete(student.id);
                const cursorClass = state.sortConfig.studentSort === 'default' ? 'cursor-grab' : '';
                const gpaZeroClass = scores.gpa === '0.0' ? 'gpa-zero-bg' : '';
                
                let averageGpaCell = '';
                if (isLinkedAndSecondSemester && gpa) {
                    const semester1Data = yearData.semesters[0];
                    const class1Data = semester1Data.classData[semesterData.currentClassId];
                    const student1 = class1Data ? class1Data.students.find(s => s.name === student.name) : null;
                    let avgGpa = scores.gpa;
                    if (student1 && class1Data) {
                        const scores1 = calculateScores(student1.id, class1Data);
                        const avgTotalScore = Math.round((scores.totalScore + scores1.totalScore) / 2);
                        avgGpa = calculateGpa(avgTotalScore).toFixed(1);
                    }
                    averageGpaCell = `<td class="px-2 py-1 text-center font-bold text-lg text-blue-700 align-middle bg-blue-50 ${avgGpa === '0.0' ? 'zero-score' : ''}">${avgGpa}</td>`;
                }

                let bodyRow = `<tr class="student-row bg-white border-b hover:bg-gray-50 ${isComplete ? 'perfect-submission' : ''} ${cursorClass}" draggable="true" data-student-id="${student.id}">`;
                bodyRow += `<td class="student-name-cell px-2 py-1 font-medium text-gray-900 whitespace-nowrap bg-white align-middle cursor-pointer hover:bg-blue-50 ${gpaZeroClass}" data-student-id="${student.id}">${student.name}</td>`;
                if (assignmentScore) bodyRow += `<td class="px-2 py-1 text-center font-semibold text-blue-600 align-middle ${scores.assignmentScore === 0 ? 'zero-score' : ''}">${scores.assignmentScore}</td>`;
                if (midterm) bodyRow += `<td class="px-2 py-1 text-center align-middle"><input type="number" class="w-12 text-center bg-gray-100 rounded p-1 ${scores.midterm === 0 ? 'zero-score' : ''}" data-student-id="${student.id}" data-exam-type="midterm" value="${scores.midterm}" min="0" max="${classData.scoreConfig.midterm}"></td>`;
                if (final) bodyRow += `<td class="px-2 py-1 text-center align-middle"><input type="number" class="w-12 text-center bg-gray-100 rounded p-1 ${scores.final === 0 ? 'zero-score' : ''}" data-student-id="${student.id}" data-exam-type="final" value="${scores.final}" min="0" max="${classData.scoreConfig.final}"></td>`;
                if (midYear) bodyRow += `<td class="px-2 py-1 text-center align-middle"><input type="number" class="w-12 text-center bg-gray-100 rounded p-1 ${scores.midYear === 0 ? 'zero-score' : ''}" data-student-id="${student.id}" data-exam-type="midYear" value="${scores.midYear}" min="0" max="${classData.scoreConfig.midYear || ''}"></td>`;
                if (yearEnd) bodyRow += `<td class="px-2 py-1 text-center align-middle"><input type="number" class="w-12 text-center bg-gray-100 rounded p-1 ${scores.yearEnd === 0 ? 'zero-score' : ''}" data-student-id="${student.id}" data-exam-type="yearEnd" value="${scores.yearEnd}" min="0" max="${classData.scoreConfig.yearEnd || ''}"></td>`;
                classData.specialColumns.forEach(col => {
                     if (classData.columnVisibility[`special-${col.id}`]) {
                        const score = classData.specialScores[`${student.id}-${col.id}`] || 0;
                        bodyRow += `<td class="px-2 py-1 text-center align-middle"><input type="number" class="w-16 text-center bg-gray-100 rounded p-1" data-student-id="${student.id}" data-column-id="${col.id}" value="${score}"></td>`;
                     }
                });
                if (totalScore) bodyRow += `<td class="px-2 py-1 text-center font-bold text-lg text-green-700 align-middle ${scores.totalScore === 0 ? 'zero-score' : ''}">${scores.totalScore}</td>`;
                if (gpa) bodyRow += `<td class="px-2 py-1 text-center font-bold text-lg text-purple-700 align-middle ${scores.gpa === '0.0' ? 'zero-score' : ''}">${scores.gpa}</td>`;
                bodyRow += averageGpaCell;
                sortedAssignments.forEach(assignment => {
                    const progressScore = classData.progressScores ? classData.progressScores[`${student.id}-${assignment.id}`] : undefined;
                    const grade = classData.grades[`${student.id}-${assignment.id}`] || 'none';
                    let displayText, displayClass;
                    if (progressScore !== undefined && progressScore !== null && progressScore !== '') {
                        displayText = progressScore;
                        displayClass = 'status-progress';
                    } else {
                        displayText = grade === 'none' ? '-' : grade;
                        displayClass = `status-${grade}`;
                    }
                    bodyRow += `<td class="p-1 text-center align-middle"><div class="table-cell-status square-box ${displayClass} font-bold rounded-md" data-student-id="${student.id}" data-assignment-id="${assignment.id}">${displayText}</div></td>`;
                });
                bodyRow += `<td class="px-2 py-1 text-center align-middle"><button class="remove-student-btn text-red-500 hover:text-red-700 text-xs" data-student-id="${student.id}">ลบ</button></td>`;
                bodyRow += '</tr>';
                tbody.innerHTML += bodyRow;
            });

            let actionRow = `<tr class="bg-gray-50 h-[38px]"><td class="sticky left-0 bg-gray-50 px-2 py-1"></td>`;
            if(assignmentScore) actionRow += '<td></td>'; if(midterm) actionRow += '<td></td>'; if(final) actionRow += '<td></td>'; if(midYear) actionRow += '<td></td>'; if(yearEnd) actionRow += '<td></td>';
            classData.specialColumns.forEach(col => {
                if (classData.columnVisibility[`special-${col.id}`]) {
                     actionRow += `<td class="p-1 text-center align-middle">
                        <button class="edit-special-column-btn text-xs text-blue-500 hover:underline" data-column-id="${col.id}">แก้ไข</button>
                        <button class="remove-special-column-btn text-xs text-red-500 hover:underline ml-1" data-column-id="${col.id}">ลบ</button></td>`;
                }
            });
            if(totalScore) actionRow += '<td></td>'; if(gpa) actionRow += '<td></td>';
            if (isLinkedAndSecondSemester && gpa) actionRow += '<td></td>';
            sortedAssignments.forEach(a => {
                actionRow += `<td class="p-1 text-center align-middle">
                    <button class="edit-assignment-btn text-xs text-blue-500 hover:underline" data-assignment-id="${a.id}">แก้ไข</button>
                    <button class="remove-assignment-btn text-xs text-red-500 hover:underline ml-1" data-assignment-id="${a.id}">ลบ</button></td>`;
            });
            actionRow += '<td></td></tr>';
            tbody.innerHTML += actionRow;
            gradebookTable.appendChild(tbody);
            
            const sortIndicator = document.getElementById('sortIndicator');
            if (sortIndicator) {
                if (studentSortOrder === 'desc') sortIndicator.textContent = '▼';
                else if (studentSortOrder === 'asc') sortIndicator.textContent = '▲';
                else sortIndicator.textContent = '';
            }

            attachTableEventListeners();
        };

        const updateToggleButtons = () => {
            const classData = getCurrentClassData();
            if (!classData) return;
            const columnVisibility = classData.columnVisibility;
            const container = document.getElementById('columnToggleContainer');
            container.querySelectorAll('.special-toggle').forEach(btn => btn.remove());
            container.querySelectorAll('.toggle-column-btn:not(.special-toggle)').forEach(btn => {
                btn.classList.toggle('toggle-btn-active', columnVisibility[btn.dataset.column]);
                btn.classList.toggle('toggle-btn-inactive', !columnVisibility[btn.dataset.column]);
            });
            
            classData.specialColumns.forEach(col => {
                const key = `special-${col.id}`;
                const btn = document.createElement('button');
                btn.dataset.column = key;
                btn.className = 'toggle-column-btn special-toggle text-sm font-bold py-2 px-3 rounded-lg shadow';
                btn.textContent = col.name;
                btn.classList.toggle('toggle-btn-active', columnVisibility[key]);
                btn.classList.toggle('toggle-btn-inactive', !columnVisibility[key]);
                btn.addEventListener('click', handleToggleColumn);
                container.appendChild(btn);
            });
        };
        
        const renderSummaryModal = () => {
            const tbody = document.getElementById('summaryTableBody');
            tbody.innerHTML = '';
            const classData = getCurrentClassData();
            if (!classData) return;
            classData.assignments.forEach((assignment, index) => {
                const dueDate = getDueDate(assignment);
                const overdue = isOverdue(assignment);
                const row = document.createElement('tr');
                row.className = `bg-white border-b hover:bg-gray-50 cursor-pointer ${overdue ? 'bg-red-50' : ''}`;
                row.dataset.assignmentId = assignment.id;
                
                const statusHtml = overdue 
                    ? `<span class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded-full">พ้นกำหนด</span>` 
                    : '';

                row.innerHTML = `<td class="px-4 py-1">${index + 1}</td><td class="px-4 py-1">${assignment.chapter || '-'}</td>
                    <td class="px-4 py-1 w-1/2">${assignment.name || '-'}</td><td class="px-4 py-1 text-center">${assignment.weight || 1}</td><td class="px-4 py-1 text-center">${assignment.quantity || '-'}</td>
                    <td class="px-4 py-1 text-center">${assignment.page || '-'}</td><td class="px-4 py-1 whitespace-nowrap">${assignment.assignedDate || '-'}</td>
                    <td class="px-4 py-1 whitespace-nowrap">${dueDate ? formatDate(dueDate) : '-'}</td>
                    <td class="px-4 py-1 text-center">${statusHtml}</td>`;
                row.addEventListener('click', () => {
                    closeModal(document.getElementById('summaryModal'));
                    handleAssignmentHeaderClick(assignment.id);
                });
                tbody.appendChild(row);
            });
        };

        const renderBulkGradeModal = (assignmentId) => {
            const classData = getCurrentClassData();
            if (!classData) return;
            const assignment = classData.assignments.find(a => a.id === assignmentId);
            if (!assignment) return;
            const modalTitle = document.getElementById('bulkGradeModalTitle');
            const container = document.getElementById('bulkGradeTableBody');
            container.innerHTML = '';
            const filterCheckbox = document.getElementById('bulkGradeFilter');
            
            const studentsToGrade = classData.students.filter(student => {
                if (!filterCheckbox.checked) return true;
                const gradeKey = `${student.id}-${assignment.id}`;
                const hasGrade = classData.grades[gradeKey];
                const hasProgressScore = classData.progressScores && classData.progressScores[gradeKey] !== undefined && classData.progressScores[gradeKey] !== null && classData.progressScores[gradeKey] !== '';
                return !hasGrade && !hasProgressScore;
            });

            const unsubmittedCount = studentsToGrade.length;
            modalTitle.innerHTML = `ให้คะแนนงาน: <span class="font-normal text-gray-600">${assignment.name}</span> <span class="text-sm font-normal text-red-500 ml-2">(${unsubmittedCount} คนที่ยังไม่ส่ง)</span>`;
            modalTitle.dataset.assignmentId = assignmentId;

            studentsToGrade.forEach(student => {
                const currentGrade = classData.grades[`${student.id}-${assignment.id}`] || 'none';
                const row = document.createElement('div');
                row.className = 'grid grid-cols-3 gap-2 items-center py-2 border-b';
                
                let buttonsHtml = ['A', 'B', 'C', 'D', 'none'].map(status => {
                    const text = status === 'none' ? 'ยังไม่ส่ง' : status;
                    return `<button data-status="${status}" class="bulk-grade-btn status-${status} rounded-md shadow ${status === 'none' ? 'text-xs' : ''} ${currentGrade === status ? 'selected' : ''}">${text}</button>`;
                }).join('');
                
                row.innerHTML = `
                    <div class="col-span-1"><button class="student-link-btn hover:underline text-left">${student.name}</button></div>
                    <div class="col-span-2"><div class="flex justify-end gap-1 sm:gap-2">${buttonsHtml}</div></div>
                `;

                row.querySelector('.student-link-btn').addEventListener('click', () => {
                    closeModal(document.getElementById('bulkGradeModal'));
                    handleStudentNameClick(student.id);
                });
                row.querySelectorAll('.bulk-grade-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const newStatus = e.currentTarget.dataset.status;
                        commitChange(() => {
                            const classData = getCurrentClassData();
                            const gradeKey = `${student.id}-${assignment.id}`;
                            if (newStatus === 'none') delete classData.grades[gradeKey];
                            else classData.grades[gradeKey] = newStatus;
                        });
                        renderBulkGradeModal(assignmentId);
                    });
                });
                container.appendChild(row);
            });
        };

        const renderStudentGradeModal = (studentId) => {
            const classData = getCurrentClassData();
            if (!classData) return;
            const student = classData.students.find(s => s.id === studentId);
            if (!student) return;
            const modalTitle = document.getElementById('studentGradeModalTitle');
            const container = document.getElementById('studentGradeTableBody');
            container.innerHTML = '';
            const filterCheckbox = document.getElementById('studentGradeFilter');

            const allAssignments = classData.assignments;
            let assignmentsToGrade = allAssignments;

            if (filterCheckbox.checked) {
                assignmentsToGrade = allAssignments.filter(assignment => {
                    const gradeKey = `${student.id}-${assignment.id}`;
                    const hasGrade = classData.grades[gradeKey];
                    const hasProgressScore = classData.progressScores && classData.progressScores[gradeKey] !== undefined && classData.progressScores[gradeKey] !== null && classData.progressScores[gradeKey] !== '';
                    return !hasGrade && !hasProgressScore;
                });
            }
            
            const unsubmittedCount = assignmentsToGrade.length;
            modalTitle.innerHTML = `ให้คะแนน: <span class="font-normal text-gray-600">${student.name}</span> <span class="text-sm font-normal text-red-500 ml-2">(เหลืองาน ${unsubmittedCount} ชิ้น)</span>`;
            modalTitle.dataset.studentId = studentId;

            assignmentsToGrade.forEach(assignment => {
                const originalIndex = allAssignments.findIndex(a => a.id === assignment.id);
                const currentGrade = classData.grades[`${student.id}-${assignment.id}`] || 'none';
                const row = document.createElement('div');
                row.className = 'grid grid-cols-3 gap-2 items-center py-2 border-b';
                
                let buttonsHtml = ['A', 'B', 'C', 'D', 'none'].map(status => {
                    const isSelected = currentGrade === status;
                    const text = status === 'none' ? 'ยังไม่ส่ง' : status;
                    return `<button data-status="${status}" class="bulk-grade-btn status-${status} rounded-md shadow hover:opacity-80 transition ${status === 'none' ? 'text-xs' : ''} ${isSelected ? 'selected' : ''}">${text}</button>`;
                }).join('');
                
                row.innerHTML = `
                    <div class="col-span-1"><button class="assignment-link-btn hover:underline text-left text-sm">${originalIndex + 1}. ${assignment.name}</button></div>
                    <div class="col-span-2"><div class="flex justify-end gap-1 sm:gap-2">${buttonsHtml}</div></div>
                `;

                row.querySelector('.assignment-link-btn').addEventListener('click', () => {
                    closeModal(document.getElementById('studentGradeModal'));
                    handleAssignmentHeaderClick(assignment.id);
                });
                row.querySelectorAll('.bulk-grade-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const newStatus = e.currentTarget.dataset.status;
                        commitChange(() => {
                            const classData = getCurrentClassData();
                            const gradeKey = `${student.id}-${assignment.id}`;
                            if (newStatus === 'none') delete classData.grades[gradeKey];
                            else classData.grades[gradeKey] = newStatus;
                        });
                        renderStudentGradeModal(studentId);
                    });
                });
                container.appendChild(row);
            });
        };
        
        const renderDashboard = () => {
            const classData = getCurrentClassData();
            const dashboardTitle = document.getElementById('dashboardTitle');
            if (!classData || !classData.students.length) {
                dashboardTitle.textContent = `สรุปผลภาพรวม - ไม่มีข้อมูล`;
                // Clear dashboard content
                if(submissionChartInstance) submissionChartInstance.destroy();
                if(performanceChartInstance) performanceChartInstance.destroy();
                document.getElementById('studentsAtRiskList').innerHTML = '<li>ไม่มีข้อมูล</li>';
                document.getElementById('topPerformersList').innerHTML = '<li>ไม่มีข้อมูล</li>';
                return;
            }
            const semesterData = getCurrentSemesterData();
            const currentClass = semesterData.classes.find(c => c.id === semesterData.currentClassId);
            dashboardTitle.textContent = `สรุปผลภาพรวม: ${currentClass.name}`;
            
            // 1. Submission Overview Data
            let submittedCount = 0;
            let missingCount = 0;
            
            classData.students.forEach(student => {
                classData.assignments.forEach(assignment => {
                    const gradeKey = `${student.id}-${assignment.id}`;
                    const hasGrade = classData.grades[gradeKey] && classData.grades[gradeKey] !== 'none';
                    const hasProgress = classData.progressScores && classData.progressScores[gradeKey];
                    if (hasGrade || hasProgress) {
                        submittedCount++;
                    } else {
                        missingCount++;
                    }
                });
            });

            // 2. Assignment Performance Data
            const assignmentLabels = classData.assignments.map((a, i) => `งานที่ ${i + 1}`);
            const assignmentSubmissionRates = classData.assignments.map(assignment => {
                let count = 0;
                classData.students.forEach(student => {
                     const gradeKey = `${student.id}-${assignment.id}`;
                     if (classData.grades[gradeKey] || (classData.progressScores && classData.progressScores[gradeKey])) {
                         count++;
                     }
                });
                return (count / classData.students.length) * 100;
            });

            // 3. Students at Risk & Top Performers
            const studentSubmissionCounts = classData.students.map(student => {
                let submittedCount = 0;
                 classData.assignments.forEach(assignment => {
                     const gradeKey = `${student.id}-${assignment.id}`;
                     const hasGrade = classData.grades[gradeKey] && classData.grades[gradeKey] !== 'none';
                     const hasProgress = classData.progressScores && classData.progressScores[gradeKey];
                     if (hasGrade || hasProgress) {
                         submittedCount++;
                     }
                });
                return { 
                    id: student.id,
                    name: student.name, 
                    submittedCount: submittedCount,
                    missingCount: classData.assignments.length - submittedCount
                };
            });

            const totalAssignments = classData.assignments.length;
            const studentsAtRisk = studentSubmissionCounts
                .filter(s => totalAssignments > 0 && s.submittedCount < totalAssignments / 2)
                .sort((a, b) => a.submittedCount - b.submittedCount);

            const topPerformers = studentSubmissionCounts
                .filter(s => s.missingCount <= 1)
                .sort((a, b) => {
                    const scoreB = calculateScores(b.id).totalScore;
                    const scoreA = calculateScores(a.id).totalScore;
                    if (scoreB !== scoreA) {
                        return scoreB - scoreA;
                    }
                    return a.id - b.id; // Secondary sort by student ID (like student number)
                });

            // Render Lists
            const atRiskList = document.getElementById('studentsAtRiskList');
            atRiskList.innerHTML = '';
            if (studentsAtRisk.length > 0) {
                studentsAtRisk.forEach(s => {
                    const li = document.createElement('li');
                    li.textContent = `${s.name} (ค้าง ${s.missingCount} งาน)`;
                    atRiskList.appendChild(li);
                });
            } else {
                atRiskList.innerHTML = '<li>ไม่มีนักเรียนที่ส่งงานไม่ถึงครึ่ง 🎉</li>';
            }

            const topPerformersList = document.getElementById('topPerformersList');
            topPerformersList.innerHTML = '';
            if (topPerformers.length > 0) {
                topPerformers.forEach(s => {
                    const li = document.createElement('li');
                    li.textContent = s.name;
                    topPerformersList.appendChild(li);
                });
            } else {
                topPerformersList.innerHTML = '<li>ยังไม่มีนักเรียนที่เข้าเกณฑ์</li>';
            }


            // Render Charts
            if(submissionChartInstance) submissionChartInstance.destroy();
            const subCtx = document.getElementById('submissionChart').getContext('2d');
            submissionChartInstance = new Chart(subCtx, {
                type: 'pie',
                data: {
                    labels: ['ส่งแล้ว', 'ยังไม่ส่ง'],
                    datasets: [{
                        data: [submittedCount, missingCount],
                        backgroundColor: ['#10B981', '#EF4444'],
                    }]
                },
                options: { responsive: true }
            });

            if(performanceChartInstance) performanceChartInstance.destroy();
            const perfCtx = document.getElementById('performanceChart').getContext('2d');
            performanceChartInstance = new Chart(perfCtx, {
                type: 'bar',
                data: {
                    labels: assignmentLabels,
                    datasets: [{
                        label: 'อัตราการส่ง (%)',
                        data: assignmentSubmissionRates,
                        backgroundColor: '#4F46E5'
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true, max: 100 } }
                }
            });
        };
        
        const renderStudentReport = (studentId) => {
            const classData = getCurrentClassData();
            if (!classData) return;
            const student = classData.students.find(s => s.id === studentId);
            if (!student) {
                studentReportView.innerHTML = `<p class="text-red-500">ไม่พบข้อมูลนักเรียน</p>`;
                return;
            }

            const scores = calculateScores(studentId);
            const semesterData = getCurrentSemesterData();
            const currentClass = semesterData.classes.find(c => c.id === semesterData.currentClassId);

            let submitted = 0;
            let late = 0;
            classData.assignments.forEach(assignment => {
                const gradeKey = `${studentId}-${assignment.id}`;
                const grade = classData.grades[gradeKey];
                const hasProgressScore = classData.progressScores && classData.progressScores[gradeKey] !== undefined;

                if (grade || hasProgressScore) {
                    submitted++;
                    if (grade === 'C' || grade === 'D') {
                        late++;
                    }
                }
            });
            const submissionStatus = `ส่ง ${submitted}/${classData.assignments.length} ชิ้น (ช้า ${late} ชิ้น)`;

            let tableRows = '';
            classData.assignments.forEach((assignment, index) => {
                const gradeKey = `${studentId}-${assignment.id}`;
                const grade = classData.grades[gradeKey] || 'none';
                const progressScore = classData.progressScores ? classData.progressScores[gradeKey] : undefined;
                let statusText, statusClass;

                if (progressScore !== undefined && progressScore !== null && progressScore !== '') {
                    statusText = `<b>${progressScore}</b>`;
                    statusClass = 'status-progress';
                } else {
                    statusText = grade === 'none' ? '-' : grade;
                    statusClass = `status-${grade}`;
                }
                tableRows += `<tr class="border-b"><td class="p-2">${index + 1}. ${assignment.name}</td><td class="p-2 text-center"><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${statusText}</span></td></tr>`;
            });

            studentReportView.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">รายงานผลนักเรียนรายบุคคล</h2>
                            <p class="text-gray-600">${state.mainTitle} / ${currentClass.name}</p>
                        </div>
                        <button id="backToGradebookBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg shadow">
                            &larr; กลับไปที่ตาราง
                        </button>
                    </div>
                    
                    <div class="border-t border-b py-4 mb-6">
                        <h3 class="text-xl font-bold text-indigo-700">${student.name}</h3>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 text-center">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p class="text-sm text-blue-700 font-semibold">คะแนนรวม</p>
                            <p class="text-3xl font-bold text-blue-800 ${scores.totalScore === 0 ? 'zero-score' : ''}">${scores.totalScore}</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <p class="text-sm text-green-700 font-semibold">ผลการเรียน</p>
                            <p class="text-3xl font-bold text-green-800 ${scores.gpa === '0.0' ? 'zero-score' : ''}">${scores.gpa}</p>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <p class="text-sm text-yellow-700 font-semibold">การส่งงาน</p>
                            <p class="text-xl font-bold text-yellow-800">${submissionStatus}</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-semibold mb-2 text-center">กราฟพัฒนาการ</h3>
                            <canvas id="studentDevChart"></canvas>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-semibold mb-2 text-center">รายการส่งงาน</h3>
                            <div class="max-h-60 overflow-y-auto">
                                <table class="w-full text-sm">
                                    <thead class="sticky top-0 bg-gray-100"><tr><th class="p-2 text-left">ชื่องาน</th><th class="p-2 text-center">สถานะ</th></tr></thead>
                                    <tbody>${tableRows}</tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('backToGradebookBtn').addEventListener('click', () => {
                currentView = 'gradebook';
                state.currentStudentIdForReport = null;
                render();
            });

            // Render Chart
            const chartData = classData.assignments.map(assignment => {
                const gradeKey = `${studentId}-${assignment.id}`;
                const grade = classData.grades[gradeKey] || 'none';
                const progressScore = classData.progressScores ? classData.progressScores[gradeKey] : undefined;
                if (progressScore !== undefined && progressScore !== null && progressScore !== '') {
                    return 4; // Plot numeric scores at the level of 'A'
                } else {
                    return GRADE_SCORE_MAP[grade] || 0;
                }
            });

            const pointColors = classData.assignments.map(assignment => {
                const gradeKey = `${studentId}-${assignment.id}`;
                const progressScore = classData.progressScores ? classData.progressScores[gradeKey] : undefined;
                if (progressScore !== undefined && progressScore !== null && progressScore !== '') {
                    return '#F59E0B'; // Amber color for progress scores
                } else {
                    return '#4F46E5'; // Indigo color for letter grades
                }
            });
            
            if(studentDevChartInstance) studentDevChartInstance.destroy();
            const devCtx = document.getElementById('studentDevChart').getContext('2d');
            studentDevChartInstance = new Chart(devCtx, {
                type: 'line',
                data: {
                    labels: classData.assignments.map((a, i) => `งานที่ ${i + 1}`),
                    datasets: [{
                        label: 'คะแนน/ระดับ',
                        data: chartData,
                        borderColor: '#4F46E5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        pointBackgroundColor: pointColors,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: { 
                        y: { 
                            beginAtZero: true,
                            max: 4.5,
                            ticks: {
                                stepSize: 1,
                                callback: function(value, index, values) {
                                    switch(value) {
                                        case 4: return 'A';
                                        case 3: return 'B';
                                        case 2: return 'C';
                                        case 1: return 'D';
                                        case 0: return 'ยังไม่ส่ง';
                                        default: return '';
                                    }
                                }
                            }
                        } 
                    }
                }
            });
        };


        // --- MODAL CONTROLLERS ---
        const openModal = (modal) => {
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('.modal-content').classList.remove('-translate-y-10');
            }, 10);
        };

        const closeModal = (modal) => {
            modal.classList.add('opacity-0');
            modal.querySelector('.modal-content').classList.add('-translate-y-10');
            setTimeout(() => {
                modal.classList.add('hidden');
                if (modal.id === 'bulkGradeModal' || modal.id === 'studentGradeModal') render();
            }, 250);
        };

        const openInputModal = (config) => {
            document.getElementById('inputModalTitle').textContent = config.title;
            document.getElementById('inputModalDesc').textContent = config.description || '';
            const inputField = document.getElementById('inputModalField');
            const textareaField = document.getElementById('inputModalTextarea');
            currentInputType = config.inputType || 'input';
            if (currentInputType === 'textarea') {
                inputField.style.display = 'none';
                textareaField.style.display = 'block';
                textareaField.value = config.defaultValue || '';
                textareaField.placeholder = config.placeholder || '';
                textareaField.focus();
            } else {
                textareaField.style.display = 'none';
                inputField.style.display = 'block';
                inputField.value = config.defaultValue || '';
                inputField.placeholder = config.placeholder || '';
                inputField.focus();
            }
            onInputConfirm = config.onConfirm;
            openModal(document.getElementById('inputModal'));
        };
        
        const openAssignmentModal = (config) => {
            document.getElementById('assignmentModalTitle').textContent = config.title;
            const form = document.getElementById('assignmentForm');
            form.reset();
            document.getElementById('assignmentDate').value = config.assignment?.assignedDate || formatDate(new Date());
            document.getElementById('daysToSubmit').value = config.assignment?.daysToSubmit || 7;
            document.getElementById('assignmentWeight').value = config.assignment?.weight || 1;
            if (config.assignment) {
                document.getElementById('assignmentName').value = config.assignment.name || '';
                document.getElementById('assignmentChapter').value = config.assignment.chapter || '';
                document.getElementById('assignmentQuantity').value = config.assignment.quantity || '';
                document.getElementById('assignmentPage').value = config.assignment.page || '';
            }
            onAssignmentConfirm = config.onConfirm;
            openModal(document.getElementById('assignmentModal'));
        };

        // --- EVENT HANDLERS ---
        const handleSearch = (e) => {
            const searchTerm = e.target.value.toLowerCase();
            if (currentView === 'gradebook') {
                const table = document.getElementById('gradebookTable');
                if (!table) return;
                const rows = table.querySelectorAll('tbody .student-row');
                rows.forEach(row => {
                    const studentName = row.querySelector('.student-name-cell').textContent.toLowerCase();
                    row.style.display = studentName.includes(searchTerm) ? '' : 'none';
                });
            } else if (currentView === 'warehouse') {
                const tableId = currentWarehouseView === 'failed' ? '#failedWarehouseTableBody' : '#resolvedWarehouseTableBody';
                const table = document.querySelector(tableId);
                if (!table) return;
                const rows = table.querySelectorAll('tr');
                rows.forEach(row => {
                    const rowText = row.textContent.toLowerCase();
                    row.style.display = rowText.includes(searchTerm) ? '' : 'none';
                });
            }
        };

        const handleUndo = () => {
            if (historyIndex > 0) {
                isTimeTraveling = true;
                historyIndex--;
                state = JSON.parse(JSON.stringify(historyStack[historyIndex]));
                saveStateToFirebase();
                render();
                updateUndoRedoButtons();
                isTimeTraveling = false;
            }
        };

        const handleRedo = () => {
            if (historyIndex < historyStack.length - 1) {
                isTimeTraveling = true;
                historyIndex++;
                state = JSON.parse(JSON.stringify(historyStack[historyIndex]));
                saveStateToFirebase();
                render();
                updateUndoRedoButtons();
                isTimeTraveling = false;
            }
        };

        const handleSwitchClass = (classId) => commitChange(() => { getCurrentSemesterData().currentClassId = classId; });
        const handleAddClass = () => openInputModal({
            title: 'เพิ่มห้องเรียนใหม่', description: 'กรุณากรอกชื่อห้องเรียน (เช่น ม.1/2)', placeholder: 'ชื่อห้องเรียน',
            onConfirm: (name) => {
                if (name && name.trim()) {
                    commitChange(() => {
                        const semesterData = getCurrentSemesterData();
                        const newId = semesterData.classes.length > 0 ? Math.max(...semesterData.classes.map(c => c.id)) + 1 : 1;
                        semesterData.classes.push({ id: newId, name: name.trim() });
                        semesterData.classData[newId] = getNewClassData();
                        semesterData.currentClassId = newId;
                    });
                }
            }
        });

        const handleEditClassName = (classId, currentName) => openInputModal({
            title: 'แก้ไขชื่อห้องเรียน',
            defaultValue: currentName,
            onConfirm: (newName) => {
                if (newName && newName.trim()) {
                    commitChange(() => {
                        const semesterData = getCurrentSemesterData();
                        const classIndex = semesterData.classes.findIndex(c => c.id === classId);
                        if (classIndex !== -1) {
                            semesterData.classes[classIndex].name = newName.trim();
                        }
                    });
                }
            }
        });

        const handleAddStudent = () => openInputModal({
            title: 'เพิ่มนักเรียนใหม่', description: 'กรุณากรอกชื่อนักเรียน โดยใช้ 1 บรรทัดต่อ 1 คน',
            placeholder: 'เด็กชายสมชาย เรียนดี\nเด็กหญิงสมศรี ตั้งใจ', inputType: 'textarea',
            onConfirm: (names) => {
                const nameList = names.split('\n').map(name => name.trim()).filter(name => name);
                if (nameList.length > 0) {
                    commitChange(() => {
                        const classData = getCurrentClassData();
                        let maxId = classData.students.length > 0 ? Math.max(...classData.students.map(s => s.id)) : 0;
                        nameList.forEach(name => { maxId++; classData.students.push({ id: maxId, name: name }); });
                    });
                }
            }
        });

        const handleAddAssignment = () => openAssignmentModal({
            title: 'เพิ่มงานใหม่',
            onConfirm: (data) => {
                commitChange(() => {
                    const classData = getCurrentClassData();
                    const newId = classData.assignments.length > 0 ? Math.max(...classData.assignments.map(a => a.id)) + 1 : 1;
                    classData.assignments.push({ id: newId, ...data });
                });
            }
        });

        const handleAddSpecialColumn = () => openInputModal({
            title: 'เพิ่มคอลัมน์พิเศษ', description: 'กรุณากรอกชื่อคอลัมน์ (เช่น จิตพิสัย)', placeholder: 'ชื่อคอลัมน์',
            onConfirm: (name) => {
                if (name && name.trim()) {
                    commitChange(() => {
                        const classData = getCurrentClassData();
                        const newId = classData.specialColumns.length > 0 ? Math.max(...classData.specialColumns.map(c => c.id)) + 1 : 1;
                        classData.specialColumns.push({ id: newId, name: name.trim() });
                        classData.columnVisibility[`special-${newId}`] = true;
                    });
                }
            }
        });
        
        const handleViewSummary = () => { renderSummaryModal(); openModal(document.getElementById('summaryModal')); };
        const handleAssignmentHeaderClick = (id) => { renderBulkGradeModal(id); openModal(document.getElementById('bulkGradeModal')); };
        
        const handleStudentNameClick = (id) => {
            renderStudentGradeModal(id);
            openModal(document.getElementById('studentGradeModal'));
        };

        const handleViewStudentReport = (studentId) => {
            closeModal(document.getElementById('studentGradeModal'));
            currentView = 'studentReport';
            state.currentStudentIdForReport = studentId;
            render();
        };

        const handleEditAssignment = (id) => {
            const classData = getCurrentClassData();
            const assignment = classData.assignments.find(a => a.id === parseInt(id));
            if (!assignment) return;
            openAssignmentModal({
                title: 'แก้ไขรายละเอียดงาน', assignment: assignment,
                onConfirm: (data) => {
                    commitChange(() => {
                        const index = getCurrentClassData().assignments.findIndex(a => a.id === parseInt(id));
                        if (index !== -1) { getCurrentClassData().assignments[index] = { ...getCurrentClassData().assignments[index], ...data }; }
                    });
                }
            });
        };
        
        const handleEditSpecialColumn = (id) => {
            const classData = getCurrentClassData();
            const column = classData.specialColumns.find(c => c.id === parseInt(id));
            if (!column) return;
            openInputModal({
                title: 'แก้ไขชื่อคอลัมน์', description: `เปลี่ยนชื่อคอลัมน์ "${column.name}"`,
                placeholder: 'ชื่อคอลัมน์ใหม่', defaultValue: column.name,
                onConfirm: (newName) => {
                    if (newName && newName.trim()) {
                        commitChange(() => {
                            const index = getCurrentClassData().specialColumns.findIndex(c => c.id === parseInt(id));
                            if (index !== -1) { getCurrentClassData().specialColumns[index].name = newName.trim(); }
                        });
                    }
                }
            });
        };

        const handleRemoveAssignment = (id) => {
            const classData = getCurrentClassData();
            const assignment = classData.assignments.find(a => a.id === parseInt(id));
            if (!assignment) return;
            openInputModal({
                title: `ลบงาน: ${assignment.name}`, description: 'หากต้องการยืนยัน พิมพ์ "ลบ"', placeholder: 'พิมพ์ "ลบ"',
                onConfirm: (confirmation) => {
                    if (confirmation === 'ลบ') {
                        commitChange(() => {
                            const currentClassData = getCurrentClassData();
                            currentClassData.assignments = currentClassData.assignments.filter(a => a.id !== parseInt(id));
                            Object.keys(currentClassData.grades).forEach(key => { if (key.endsWith(`-${id}`)) delete currentClassData.grades[key]; });
                        });
                    }
                }
            });
        };

        const handleRemoveSpecialColumn = (id) => {
            const classData = getCurrentClassData();
            const column = classData.specialColumns.find(c => c.id === parseInt(id));
            if (!column) return;
            openInputModal({
                title: `ลบคอลัมน์: ${column.name}`, description: 'การดำเนินการนี้จะลบคะแนนทั้งหมดในคอลัมน์นี้ด้วย หากต้องการยืนยัน พิมพ์ "ลบ"',
                placeholder: 'พิมพ์ "ลบ"',
                onConfirm: (confirmation) => {
                    if (confirmation === 'ลบ') {
                        commitChange(() => {
                            const currentClassData = getCurrentClassData();
                            currentClassData.specialColumns = currentClassData.specialColumns.filter(c => c.id !== parseInt(id));
                            delete currentClassData.columnVisibility[`special-${id}`];
                            Object.keys(currentClassData.specialScores).forEach(key => { if (key.endsWith(`-${id}`)) delete currentClassData.specialScores[key]; });
                        });
                    }
                }
            });
        };

        const handleRemoveStudent = (id) => openInputModal({
            title: `ลบนักเรียน`, description: 'หากต้องการยืนยัน พิมพ์ "ลบ"', placeholder: 'พิมพ์ "ลบ"',
            onConfirm: (confirmation) => {
                if (confirmation === 'ลบ') {
                    commitChange(() => {
                        getCurrentClassData().students = getCurrentClassData().students.filter(s => s.id !== parseInt(id));
                    });
                }
            }
        });

        const handleDeleteClass = () => {
            const semesterData = getCurrentSemesterData();
            if (semesterData.classes.length <= 1) {
                showToast('ไม่สามารถลบห้องเรียนสุดท้ายได้', true);
                return;
            }
            const currentClassName = semesterData.classes.find(c => c.id === semesterData.currentClassId).name;
            openInputModal({
                title: `ยืนยันการลบห้องเรียน`,
                description: `การกระทำนี้จะลบห้องเรียน "${currentClassName}" และข้อมูลทั้งหมดอย่างถาวร พิมพ์ "ลบ" เพื่อยืนยัน`,
                placeholder: 'พิมพ์ "ลบ"',
                onConfirm: (confirmation) => {
                    if (confirmation === 'ลบ') {
                        commitChange(() => {
                            const semesterData = getCurrentSemesterData();
                            const classIdToDelete = semesterData.currentClassId;
                            const classIndex = semesterData.classes.findIndex(c => c.id === classIdToDelete);
                            
                            semesterData.classes.splice(classIndex, 1);
                            delete semesterData.classData[classIdToDelete];
                            
                            if (semesterData.classes.length > 0) {
                                const newIndex = Math.min(classIndex, semesterData.classes.length - 1);
                                semesterData.currentClassId = semesterData.classes[newIndex].id;
                            } else {
                                semesterData.currentClassId = null;
                            }
                        });
                        showToast(`ลบห้องเรียน "${currentClassName}" สำเร็จ`);
                    }
                }
            });
        };

        const handleClearData = () => {
            const semesterData = getCurrentSemesterData();
            const classData = getCurrentClassData();
            const currentClassName = semesterData.classes.find(c => c.id === semesterData.currentClassId).name;
            openInputModal({
                title: `ล้างข้อมูลห้องเรียน: ${currentClassName}`,
                description: 'การดำเนินการนี้จะลบข้อมูลนักเรียน, งาน, และคะแนนทั้งหมดในห้องนี้อย่างถาวร หากต้องการยืนยัน พิมพ์ "ลบ"',
                placeholder: 'พิมพ์ "ลบ"',
                onConfirm: (confirmation) => {
                    if (confirmation === 'ลบ') {
                        commitChange(() => {
                            const currentSemester = getCurrentSemesterData();
                            const currentClassId = currentSemester.currentClassId;
                            const studentsToClear = [...currentSemester.classData[currentClassId].students];

                            // Explicitly remove students of this class from warehouses
                            studentsToClear.forEach(student => {
                                const warehouseKey = `${state.currentAcademicYear}-${currentSemester.id}-${currentClassId}-${student.id}`;
                                if (state.failedStudentWarehouse[warehouseKey]) {
                                    delete state.failedStudentWarehouse[warehouseKey];
                                }
                                if (state.resolvedFailedStudents[warehouseKey]) {
                                    delete state.resolvedFailedStudents[warehouseKey];
                                }
                            });
                            
                            // Reset the class data
                            currentSemester.classData[currentClassId] = getNewClassData();
                        });
                    }
                }
            });
        };

        const handleToggleColumn = (e) => commitChange(() => { 
            const classData = getCurrentClassData();
            classData.columnVisibility[e.currentTarget.dataset.column] = !classData.columnVisibility[e.currentTarget.dataset.column]; 
        });
        const handleStatusUpdate = (status) => {
            commitChange(() => {
                const classData = getCurrentClassData();
                const { studentId, assignmentId } = currentEdit;
                const gradeKey = `${studentId}-${assignmentId}`;
                if (status === 'none') delete classData.grades[gradeKey];
                else classData.grades[gradeKey] = status;
                delete classData.progressScores[gradeKey]; // Clear progress score when letter grade is set
            });
            closeModal(document.getElementById('gradeModal'));
        };

        const handleProgressScoreUpdate = (score) => {
            commitChange(() => {
                const classData = getCurrentClassData();
                const { studentId, assignmentId } = currentEdit;
                const gradeKey = `${studentId}-${assignmentId}`;
                if (score === null || score === '') {
                    delete classData.progressScores[gradeKey];
                } else {
                    classData.progressScores[gradeKey] = score;
                    delete classData.grades[gradeKey]; // Clear letter grade when progress score is set
                }
            });
        };
        
        const showTooltip = (e) => {
            const classData = getCurrentClassData();
            const assignmentId = e.currentTarget.dataset.assignmentId;
            const assignment = classData.assignments.find(a => a.id === parseInt(assignmentId));
            if (!assignment) return;
            const dueDate = getDueDate(assignment);
            
            assignmentTooltip.innerHTML = `<strong>ชื่องาน:</strong> ${assignment.name || '-'}<br><strong>มอบหมาย:</strong> ${assignment.assignedDate || '-'}<br><strong>กำหนดส่ง:</strong> ${dueDate ? formatDate(dueDate) : '-'}`;
            assignmentTooltip.style.display = 'block';
            const rect = e.currentTarget.getBoundingClientRect();
            assignmentTooltip.style.left = `${window.scrollX + rect.left}px`;
            assignmentTooltip.style.top = `${window.scrollY + rect.bottom + 5}px`;
        };

        const hideTooltip = () => { assignmentTooltip.style.display = 'none'; };
        
        function addEditListeners(element, callback) {
            element.addEventListener('dblclick', callback);
            let pressTimer;
            element.addEventListener('touchstart', (e) => {
                pressTimer = window.setTimeout(() => {
                    e.preventDefault();
                    callback();
                }, 750);
            });
            element.addEventListener('touchend', () => clearTimeout(pressTimer));
            element.addEventListener('touchmove', () => clearTimeout(pressTimer));
        }

        function attachTableEventListeners() {
            document.querySelectorAll('.table-cell-status').forEach(cell => cell.addEventListener('click', (e) => {
                currentEdit = { studentId: parseInt(e.currentTarget.dataset.studentId), assignmentId: parseInt(e.currentTarget.dataset.assignmentId) };
                const classData = getCurrentClassData();
                const student = classData.students.find(s => s.id === currentEdit.studentId);
                const assignment = classData.assignments.find(a => a.id === currentEdit.assignmentId);
                document.getElementById('modalStudentName').textContent = student.name;
                document.getElementById('modalAssignmentName').textContent = assignment.name;
                const progressScore = classData.progressScores ? classData.progressScores[`${currentEdit.studentId}-${currentEdit.assignmentId}`] : '';
                document.getElementById('modalProgressScore').value = progressScore || '';
                openModal(document.getElementById('gradeModal'));
            }));
            document.querySelectorAll('.student-name-cell').forEach(cell => {
                cell.addEventListener('click', (e) => handleStudentNameClick(parseInt(e.currentTarget.dataset.studentId)));
            });
            document.querySelectorAll('.remove-student-btn').forEach(btn => btn.addEventListener('click', (e) => handleRemoveStudent(e.currentTarget.dataset.studentId)));
            document.querySelectorAll('input[data-exam-type]').forEach(input => input.addEventListener('change', (e) => {
                commitChange(() => {
                    const classData = getCurrentClassData();
                    const { studentId, examType } = e.target.dataset;
                    let value = parseInt(e.target.value) || 0;
                    const maxScore = classData.scoreConfig[examType];
                    if (maxScore && value > maxScore) value = maxScore; 
                    if (value < 0) value = 0;
                    e.target.value = value;
                    if (!classData.examScores[studentId]) classData.examScores[studentId] = { midterm: 0, final: 0, midYear: 0, yearEnd: 0 };
                    classData.examScores[studentId][examType] = value;
                });
            }));
            document.querySelectorAll('input[data-column-id]').forEach(input => input.addEventListener('change', (e) => {
                commitChange(() => {
                    const classData = getCurrentClassData();
                    const { studentId, columnId } = e.target.dataset;
                    let value = parseInt(e.target.value) || 0;
                    if (value < 0) value = 0;
                    e.target.value = value;
                    classData.specialScores[`${studentId}-${columnId}`] = value;
                });
            }));
            document.querySelectorAll('.assignment-header').forEach(header => {
                header.addEventListener('mouseenter', showTooltip);
                header.addEventListener('mouseleave', hideTooltip);
                header.addEventListener('click', (e) => handleAssignmentHeaderClick(parseInt(e.currentTarget.dataset.assignmentId)));
            });
            document.querySelectorAll('.edit-assignment-btn').forEach(btn => btn.addEventListener('click', (e) => handleEditAssignment(e.currentTarget.dataset.assignmentId)));
            document.querySelectorAll('.remove-assignment-btn').forEach(btn => btn.addEventListener('click', (e) => handleRemoveAssignment(e.currentTarget.dataset.assignmentId)));
            document.querySelectorAll('.edit-special-column-btn').forEach(btn => btn.addEventListener('click', (e) => handleEditSpecialColumn(e.currentTarget.dataset.columnId)));
            document.querySelectorAll('.remove-special-column-btn').forEach(btn => btn.addEventListener('click', (e) => handleRemoveSpecialColumn(e.currentTarget.dataset.columnId)));
            
            const totalScoreHeader = document.getElementById('totalScoreHeader');
            if (totalScoreHeader) {
                totalScoreHeader.addEventListener('click', () => {
                    commitChange(() => {
                        const currentSort = state.sortConfig.studentSort;
                        if (currentSort === 'default') state.sortConfig.studentSort = 'desc';
                        else if (currentSort === 'desc') state.sortConfig.studentSort = 'asc';
                        else state.sortConfig.studentSort = 'default';
                    });
                });
            }

            document.querySelectorAll('.student-row').forEach(row => {
                row.addEventListener('dragstart', (e) => {
                    if (state.sortConfig.studentSort !== 'default') {
                        e.preventDefault();
                        showToast('กรุณาเปลี่ยนเป็นโหมดเรียงตามลำดับเดิมเพื่อย้ายนักเรียน', true);
                        return;
                    }
                    draggedStudentId = e.currentTarget.dataset.studentId;
                    e.currentTarget.classList.add('dragging-row');
                });

                row.addEventListener('dragend', (e) => {
                    e.currentTarget.classList.remove('dragging-row');
                    document.querySelectorAll('.student-row').forEach(r => r.classList.remove('drag-over'));
                });

                row.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const targetRow = e.currentTarget;
                    document.querySelectorAll('.student-row').forEach(r => r.classList.remove('drag-over'));
                    targetRow.classList.add('drag-over');
                });

                row.addEventListener('dragleave', (e) => {
                    e.currentTarget.classList.remove('drag-over');
                });

                row.addEventListener('drop', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.student-row').forEach(r => r.classList.remove('drag-over'));
                    const targetStudentId = e.currentTarget.dataset.studentId;

                    if (draggedStudentId && draggedStudentId !== targetStudentId) {
                        commitChange(() => {
                            const classData = getCurrentClassData();
                            const students = classData.students;
                            const draggedIndex = students.findIndex(s => s.id == draggedStudentId);
                            const targetIndex = students.findIndex(s => s.id == targetStudentId);
                            const [draggedItem] = students.splice(draggedIndex, 1);
                            students.splice(targetIndex, 0, draggedItem);
                        });
                    }
                });
            });
        }
        
        // --- DRAG & DROP HANDLERS ---
        function handleDragStart(e) {
            draggedTab = e.target;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', draggedTab.innerHTML);
            setTimeout(() => {
                draggedTab.classList.add('dragging');
            }, 0);
        }

        function handleDragOver(e) {
            e.preventDefault();
            return false;
        }

        function handleDragEnd() {
            document.querySelectorAll('.class-tab').forEach(tab => tab.classList.remove('dragging'));
        }

        function handleDrop(e) {
            e.stopPropagation();
            const targetTab = e.target.closest('.class-tab');
            if (draggedTab !== targetTab) {
                const draggedId = parseInt(draggedTab.dataset.classId);
                const targetId = parseInt(targetTab.dataset.classId);

                commitChange(() => {
                    const semesterData = getCurrentSemesterData();
                    const classes = semesterData.classes;
                    const draggedIndex = classes.findIndex(c => c.id === draggedId);
                    const targetIndex = classes.findIndex(c => c.id === targetId);
                    const [draggedItem] = classes.splice(draggedIndex, 1);
                    classes.splice(targetIndex, 0, draggedItem);
                });
            }
            return false;
        }

        // --- EXPORT/IMPORT HANDLERS ---
        const handleExport = () => {
            const wb = XLSX.utils.book_new();
            const backupWsData = [{ state_json: JSON.stringify(state) }];
            const backupWs = XLSX.utils.json_to_sheet(backupWsData);
            XLSX.utils.book_append_sheet(wb, backupWs, "GradebookBackupData_V2");
            XLSX.writeFile(wb, `gradebook_export_${new Date().toISOString().slice(0,10)}.xlsx`);
            showToast("ส่งออกข้อมูลสำรองทั้งหมดสำเร็จ");
        };
        
        const showToast = (message, isError = false) => {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.className = `toast-notification ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }, 3000);
        };

        const handleImport = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const backupSheetName = workbook.SheetNames.find(name => name.startsWith("GradebookBackupData"));
                    if (!backupSheetName) {
                        showToast('ไม่พบข้อมูลสำรองที่ถูกต้องในไฟล์นี้', true);
                        return;
                    }
                    
                    const backupSheet = XLSX.utils.sheet_to_json(workbook.Sheets[backupSheetName]);

                    if (backupSheet && backupSheet.length > 0 && backupSheet[0].state_json) {
                        const importedState = JSON.parse(backupSheet[0].state_json);
                        
                        if (importedState && (importedState.academicYears || importedState.classes)) {
                             openInputModal({
                                title: 'ยืนยันการนำเข้าข้อมูล',
                                description: 'พบข้อมูลสำรองในไฟล์ Excel ต้องการเขียนทับข้อมูลปัจจุบันทั้งหมดหรือไม่? พิมพ์ "นำเข้า" เพื่อยืนยัน',
                                placeholder: 'พิมพ์ "นำเข้า"',
                                onConfirm: (confirmation) => {
                                    if (confirmation === 'นำเข้า') {
                                        isTimeTraveling = true; // Prevent this change from being added to history
                                        // If it's old state, migrate it
                                        if (!importedState.academicYears) {
                                            state = migrateOldState(importedState);
                                        } else {
                                            state = importedState;
                                        }
                                        // Manually clear and reset history
                                        historyStack = [JSON.parse(JSON.stringify(state))];
                                        historyIndex = 0;
                                        saveStateToFirebase();
                                        render();
                                        updateUndoRedoButtons();
                                        isTimeTraveling = false;
                                        showToast('นำเข้าข้อมูลสำรองสำเร็จ!');
                                    }
                                }
                            });
                        } else {
                             showToast('ไฟล์สำรองข้อมูลไม่สมบูรณ์', true);
                        }
                    } else {
                        showToast('ไม่พบข้อมูลสำรองที่ถูกต้องในไฟล์นี้', true);
                    }

                } catch (error) {
                    console.error("Error importing file:", error);
                    showToast('เกิดข้อผิดพลาดในการนำเข้าไฟล์', true);
                } finally {
                    e.target.value = ''; // Reset file input
                }
            };
            reader.readAsArrayBuffer(file);
        };

        const handleCustomImport = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();

            reader.onload = (event) => {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    if (workbook.SheetNames.length < 2) {
                        showToast('ไฟล์ Excel ต้องมีอย่างน้อย 2 ชีต (ชีตนักเรียน และ ชีตงาน)', true);
                        return;
                    }

                    const studentSheetName = workbook.SheetNames[0];
                    const assignmentSheetName = workbook.SheetNames[1];
                    
                    const studentDataRaw = XLSX.utils.sheet_to_json(workbook.Sheets[studentSheetName], { header: 1, defval: "" });
                    const assignmentData = XLSX.utils.sheet_to_json(workbook.Sheets[assignmentSheetName]);

                    if (studentDataRaw.length < 2 || assignmentData.length === 0) {
                        showToast('ชีตข้อมูลนักเรียนและชีตข้อมูลงานต้องมีข้อมูล', true);
                        return;
                    }

                    openInputModal({
                        title: 'ยืนยันการนำเข้าข้อมูลดิบ',
                        description: 'การดำเนินการนี้จะล้างข้อมูลทั้งหมดในห้องเรียนปัจจุบัน และนำเข้าข้อมูลใหม่จากไฟล์ Excel พิมพ์ "นำเข้าข้อมูลดิบ" เพื่อยืนยัน',
                        placeholder: 'พิมพ์ "นำเข้าข้อมูลดิบ"',
                        onConfirm: (confirmation) => {
                            if (confirmation === 'นำเข้าข้อมูลดิบ') {
                                commitChange(() => {
                                    const classData = getCurrentClassData();
                                    // Reset current class data
                                    Object.assign(classData, getNewClassData());

                                    // 1. Process Assignments Sheet
                                    const assignmentMap = new Map();
                                    assignmentData.forEach((row, index) => {
                                        const newId = index + 1;
                                        const newAssignment = {
                                            id: newId,
                                            name: row['ชื่องาน'] || `งานที่ ${newId}`,
                                            chapter: row['บทที่'] || '',
                                            assignedDate: row['วันที่มอบหมาย'] || '',
                                            daysToSubmit: parseInt(row['กำหนดส่ง (วัน)']) || 7,
                                            quantity: row['จำนวน'] || '',
                                            page: row['หน้า'] || '',
                                            weight: parseFloat(row['น้ำหนักคะแนน']) || 1
                                        };
                                        classData.assignments.push(newAssignment);
                                        // Map the assignment number from the "ที่" column to the new ID
                                        const assignmentHeaderKey = row['ที่'] || (index + 1);
                                        assignmentMap.set(String(assignmentHeaderKey).trim(), newId);
                                    });

                                    // 2. Process Students Sheet
                                    const studentHeaders = studentDataRaw[0].map(h => String(h).trim());
                                    const studentRows = studentDataRaw.slice(1);
                                    const studentNameHeaderIndex = studentHeaders.findIndex(h => h === 'ชื่อ - สกุล');

                                    if (studentNameHeaderIndex === -1) {
                                        // This is a non-committing action, so we can return early
                                        showToast('ไม่พบคอลัมน์ "ชื่อ - สกุล" ในชีตนักเรียน', true);
                                        throw new Error("Import cancelled: Missing student name column.");
                                    }

                                    studentRows.forEach((row, rowIndex) => {
                                        const studentName = row[studentNameHeaderIndex];
                                        if (!studentName) return; // Skip empty rows

                                        const newStudentId = rowIndex + 1;
                                        classData.students.push({ id: newStudentId, name: studentName });

                                        studentHeaders.forEach((header, colIndex) => {
                                            const cellValue = row[colIndex];
                                            if (cellValue === null || cellValue === undefined || cellValue === "") return;

                                            // Handle exam scores
                                            if (header === 'กลางภาค') {
                                                const score = parseInt(cellValue, 10);
                                                if (!isNaN(score)) {
                                                    if (!classData.examScores[newStudentId]) classData.examScores[newStudentId] = { midterm: 0, final: 0, midYear: 0, yearEnd: 0 };
                                                    classData.examScores[newStudentId].midterm = score;
                                                }
                                            } else if (header === 'ปลายภาค') {
                                                 const score = parseInt(cellValue, 10);
                                                if (!isNaN(score)) {
                                                    if (!classData.examScores[newStudentId]) classData.examScores[newStudentId] = { midterm: 0, final: 0, midYear: 0, yearEnd: 0 };
                                                    classData.examScores[newStudentId].final = score;
                                                }
                                            // Handle assignment grades/scores
                                            } else if (assignmentMap.has(header)) {
                                                const assignmentId = assignmentMap.get(header);
                                                const gradeValue = String(cellValue).trim().toUpperCase();
                                                const gradeKey = `${newStudentId}-${assignmentId}`;

                                                if (GRADE_MULTIPLIER[gradeValue] !== undefined) {
                                                    classData.grades[gradeKey] = gradeValue;
                                                } else if (!isNaN(parseFloat(gradeValue)) && isFinite(gradeValue)) {
                                                    classData.progressScores[gradeKey] = parseFloat(gradeValue);
                                                }
                                            }
                                        });
                                    });
                                });
                                showToast('นำเข้าข้อมูลดิบสำเร็จ!');
                            }
                        }
                    });

                } catch (error) {
                    console.error("Error during custom import:", error);
                    showToast(`เกิดข้อผิดพลาด: ${error.message}`, true);
                } finally {
                    e.target.value = '';
                }
            };
            reader.readAsArrayBuffer(file);
        };

        const handleExportDashboard = () => {
            const dashboardContent = document.getElementById('dashboardContent');
            const exportButton = document.getElementById('exportDashboardBtn');
            if (dashboardContent && exportButton) {
                showToast('กำลังสร้างรูปภาพ...');
                // Temporarily hide the button
                exportButton.style.visibility = 'hidden';

                html2canvas(dashboardContent, {
                    scale: 2, // For higher resolution
                    useCORS: true,
                    backgroundColor: '#ffffff'
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'dashboard-summary.jpg';
                    link.href = canvas.toDataURL('image/jpeg', 0.95);
                    link.click();
                }).catch(err => {
                    console.error('Error exporting dashboard:', err);
                    showToast('เกิดข้อผิดพลาดในการสร้างรูปภาพ', true);
                }).finally(() => {
                    // Show the button again
                    exportButton.style.visibility = 'visible';
                });
            }
        };
        
        // --- NEW WAREHOUSE FUNCTIONS ---
        const updateFailedStudentWarehouse = () => {
            if (!state.academicYears) return;

            state.academicYears.forEach(year => {
                year.semesters.forEach(semester => {
                    semester.classes.forEach(cls => {
                        const classData = semester.classData[cls.id];
                        if (!classData || !classData.students) return;

                        classData.students.forEach(student => {
                            const scores = calculateScores(student.id, classData);
                            const warehouseKey = `${year.year}-${semester.id}-${cls.id}-${student.id}`;
                            
                            if (scores.gpa === '0.0') {
                                if (!state.resolvedFailedStudents[warehouseKey]) {
                                    if (!state.failedStudentWarehouse[warehouseKey]) {
                                        state.failedStudentWarehouse[warehouseKey] = {
                                            studentId: student.id,
                                            studentName: student.name,
                                            classId: cls.id,
                                            className: cls.name,
                                            semesterId: semester.id,
                                            semesterName: semester.name,
                                            year: year.year,
                                            totalScore: scores.totalScore,
                                            remedialGrades: {} 
                                        };
                                    } else {
                                        state.failedStudentWarehouse[warehouseKey].totalScore = scores.totalScore;
                                    }
                                }
                            } else {
                                if (state.failedStudentWarehouse[warehouseKey]) {
                                    delete state.failedStudentWarehouse[warehouseKey];
                                }
                                if (state.resolvedFailedStudents[warehouseKey]) {
                                    delete state.resolvedFailedStudents[warehouseKey];
                                }
                            }
                        });
                    });
                });
            });
        };
        
        const renderWarehouseView = () => {
            const container = document.getElementById('warehouseTableContainer');
            container.innerHTML = '';
            
            const toggle = document.getElementById('warehouseToggle');
            const toggleFailedBtn = document.getElementById('toggleFailed');
            const toggleResolvedBtn = document.getElementById('toggleResolved');

            toggleFailedBtn.classList.toggle('bg-white', currentWarehouseView === 'failed');
            toggleFailedBtn.classList.toggle('text-gray-500', currentWarehouseView !== 'failed');
            toggleResolvedBtn.classList.toggle('bg-white', currentWarehouseView === 'resolved');
            toggleResolvedBtn.classList.toggle('text-gray-500', currentWarehouseView !== 'resolved');

            const warehouseData = currentWarehouseView === 'failed' ? state.failedStudentWarehouse : state.resolvedFailedStudents;
            const tableId = currentWarehouseView === 'failed' ? 'failedWarehouseTable' : 'resolvedWarehouseTable';
            const tableBodyId = currentWarehouseView === 'failed' ? 'failedWarehouseTableBody' : 'resolvedWarehouseTableBody';
            const checkboxLabel = currentWarehouseView === 'failed' ? 'แก้แล้ว' : 'ย้ายกลับ';

            let tableHTML = `
                <div class="max-h-[60vh] overflow-auto">
                    <table id="${tableId}" class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-2">ชื่อ - สกุล</th>
                                <th class="px-4 py-2">ชั้นเรียน</th>
                                <th class="px-4 py-2">ภาคเรียน</th>
                                <th class="px-4 py-2">ปีการศึกษา</th>
                                <th class="px-4 py-2 text-center">คะแนนรวม</th>
                                <th class="px-4 py-2 text-center">${checkboxLabel}</th>
                                <th class="px-4 py-2 text-center">ดูรายละเอียด</th>
                            </tr>
                        </thead>
                        <tbody id="${tableBodyId}"></tbody>
                    </table>
                </div>`;
            container.innerHTML = tableHTML;

            const tbody = document.getElementById(tableBodyId);
            if (!warehouseData || Object.keys(warehouseData).length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-gray-500">ไม่พบข้อมูล</td></tr>`;
                return;
            }

            const entries = Object.values(warehouseData).sort((a, b) => {
                if (a.year !== b.year) return b.year - a.year;
                if (a.className !== b.className) return a.className.localeCompare(b.className);
                return a.studentName.localeCompare(b.studentName);
            });

            entries.forEach((entry) => {
                const key = `${entry.year}-${entry.semesterId}-${entry.classId}-${entry.studentId}`;
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-red-50';
                row.innerHTML = `
                    <td class="px-4 py-2 font-medium text-gray-900">${entry.studentName}</td>
                    <td class="px-4 py-2">${entry.className}</td>
                    <td class="px-4 py-2">${entry.semesterName}</td>
                    <td class="px-4 py-2">${entry.year}</td>
                    <td class="px-4 py-2 text-center font-bold text-red-600">${entry.totalScore}</td>
                    <td class="px-4 py-2 text-center"><input type="checkbox" class="warehouse-checkbox h-4 w-4" data-key="${key}"></td>
                    <td class="px-4 py-2 text-center">
                        <button class="view-failed-detail-btn text-blue-600 hover:underline" data-key="${key}">ดู</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            document.querySelectorAll('.view-failed-detail-btn').forEach(btn => {
                btn.addEventListener('click', e => renderFailedStudentDetailModal(e.currentTarget.dataset.key));
            });
            document.querySelectorAll('.warehouse-checkbox').forEach(box => {
                box.addEventListener('change', e => {
                    const key = e.currentTarget.dataset.key;
                    if (currentWarehouseView === 'failed') {
                        handleResolveStudent(key);
                    } else {
                        handleUnresolveStudent(key);
                    }
                });
            });
        };
        
        const handleRemedialGrade = async (key, assignmentId) => {
            const contentDiv = document.getElementById('failedStudentDetailContent');
            const scrollPosition = contentDiv ? contentDiv.scrollTop : 0;

            let entry = state.failedStudentWarehouse[key] || state.resolvedFailedStudents[key];
            if (entry) {
                if (!entry.remedialGrades) {
                    entry.remedialGrades = {};
                }
                entry.remedialGrades[assignmentId] = 'D';
                await saveStateToFirebase(); 
                renderFailedStudentDetailModal(key, scrollPosition);
            }
        };

        const handleRevertRemedialGrade = async (key, assignmentId) => {
            const contentDiv = document.getElementById('failedStudentDetailContent');
            const scrollPosition = contentDiv ? contentDiv.scrollTop : 0;

            let entry = state.failedStudentWarehouse[key] || state.resolvedFailedStudents[key];
            if (entry && entry.remedialGrades) {
                delete entry.remedialGrades[assignmentId];
                await saveStateToFirebase();
                renderFailedStudentDetailModal(key, scrollPosition);
            }
        };

        const renderFailedStudentDetailModal = (key, scrollPosition = 0) => {
            const entry = state.failedStudentWarehouse[key] || state.resolvedFailedStudents[key];
            if (!entry) return;

            const yearData = state.academicYears.find(y => y.year === entry.year);
            const semesterData = yearData.semesters.find(s => s.id === entry.semesterId);
            const classData = semesterData.classData[entry.classId];
            const student = classData.students.find(s => s.id === entry.studentId);
            
            if (!student) {
                showToast('ไม่พบข้อมูลนักเรียน', true);
                return;
            }

            const showAll = state.warehouseDetailShowAll || false;

            const tempClassData = JSON.parse(JSON.stringify(classData));
            if (entry.remedialGrades) {
                for (const assignmentId in entry.remedialGrades) {
                    const gradeKey = `${student.id}-${assignmentId}`;
                    tempClassData.grades[gradeKey] = entry.remedialGrades[assignmentId];
                }
            }

            const scores = calculateScores(student.id, tempClassData);

            const assignmentsToShow = classData.assignments.filter(assignment => {
                if (showAll) {
                    return true;
                }
                const gradeKey = `${student.id}-${assignment.id}`;
                const originalGrade = classData.grades[gradeKey] || 'none';
                const hasRemedialGrade = entry.remedialGrades && entry.remedialGrades[assignment.id];
                return originalGrade === 'none' || hasRemedialGrade;
            });

            let tableRows = '';
            assignmentsToShow.forEach((assignment, index) => {
                const gradeKey = `${student.id}-${assignment.id}`;
                const grade = tempClassData.grades[gradeKey] || 'none';
                const progressScore = tempClassData.progressScores ? tempClassData.progressScores[gradeKey] : undefined;
                
                let statusText, statusClass;

                if (progressScore !== undefined && progressScore !== null && progressScore !== '') {
                    statusText = `<b>${progressScore}</b>`;
                    statusClass = 'status-progress';
                } else {
                    statusText = grade === 'none' ? 'ยังไม่ส่ง' : grade;
                    statusClass = `status-${grade}`;
                }

                let remedialButtonHtml = '<td></td>';
                const hasRemedialGrade = entry.remedialGrades && entry.remedialGrades[assignment.id];
                const originalGrade = classData.grades[gradeKey] || 'none';

                if (hasRemedialGrade) {
                     remedialButtonHtml = `<td class="p-2 text-center">
                        <button class="revert-remedial-btn bg-gray-400 hover:bg-gray-500 text-white text-xs font-bold py-1 px-2 rounded" data-key="${key}" data-assignment-id="${assignment.id}">
                           ยกเลิก
                        </button>
                    </td>`;
                } else if (originalGrade === 'none') {
                    remedialButtonHtml = `<td class="p-2 text-center">
                        <button class="remedial-grade-btn bg-yellow-400 hover:bg-yellow-500 text-yellow-800 text-xs font-bold py-1 px-2 rounded" data-key="${key}" data-assignment-id="${assignment.id}">
                            แก้ 0 (D)
                        </button>
                    </td>`;
                }

                tableRows += `<tr class="border-b ${grade === 'none' && !hasRemedialGrade ? 'bg-red-50' : ''}">
                    <td class="p-2">${index + 1}</td>
                    <td class="p-2 text-center">${assignment.chapter || '-'}</td>
                    <td class="p-2">${assignment.name}</td>
                    <td class="p-2 text-center">${assignment.weight || 1}</td>
                    <td class="p-2 text-center">${assignment.quantity || '-'}</td>
                    <td class="p-2 text-center">${assignment.page || '-'}</td>
                    <td class="p-2 text-center"><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${statusText}</span></td>
                    ${remedialButtonHtml}
                </tr>`;
            });

            const contentDiv = document.getElementById('failedStudentDetailContent');
            contentDiv.innerHTML = `
                <div class="space-y-4">
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h4 class="text-lg font-bold">${student.name}</h4>
                        <p class="text-gray-600">${entry.className} / ${entry.semesterName} ปีการศึกษา ${entry.year}</p>
                    </div>
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div class="bg-red-100 p-3 rounded-lg"><p class="text-sm text-red-700">คะแนนรวม</p><p class="text-2xl font-bold text-red-800">${scores.totalScore}</p></div>
                        <div class="bg-red-100 p-3 rounded-lg"><p class="text-sm text-red-700">ผลการเรียน</p><p class="text-2xl font-bold text-red-800">${scores.gpa}</p></div>
                        <div class="bg-red-100 p-3 rounded-lg"><p class="text-sm text-red-700">คะแนนเก็บ</p><p class="text-2xl font-bold text-red-800">${scores.assignmentScore}</p></div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-semibold">รายการส่งงาน</h4>
                            <div class="flex items-center">
                                <input type="checkbox" id="warehouseDetailFilter" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" ${showAll ? 'checked' : ''}>
                                <label for="warehouseDetailFilter" class="ml-2 block text-sm text-gray-900">แสดงงานทั้งหมด</label>
                            </div>
                        </div>
                        <div class="max-h-60 overflow-y-auto border rounded-lg">
                            <table class="w-full text-sm">
                                <thead class="sticky top-0 bg-gray-100">
                                    <tr>
                                        <th class="p-2 text-left">ที่</th>
                                        <th class="p-2 text-center">บทที่</th>
                                        <th class="p-2 text-left w-2/5">ชื่องาน</th>
                                        <th class="p-2 text-center">น้ำหนัก</th>
                                        <th class="p-2 text-center">จำนวน</th>
                                        <th class="p-2 text-center">หน้า</th>
                                        <th class="p-2 text-center">สถานะ</th>
                                        <th class="p-2 text-center">แก้ 0</th>
                                    </tr>
                                </thead>
                                <tbody>${tableRows}</tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('warehouseDetailFilter').addEventListener('change', async (e) => {
                const currentScroll = contentDiv.scrollTop;
                state.warehouseDetailShowAll = e.target.checked;
                await saveStateToFirebase();
                renderFailedStudentDetailModal(key, currentScroll);
            });

            contentDiv.querySelectorAll('.remedial-grade-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const key = e.currentTarget.dataset.key;
                    const assignmentId = e.currentTarget.dataset.assignmentId;
                    handleRemedialGrade(key, assignmentId);
                });
            });

            contentDiv.querySelectorAll('.revert-remedial-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const key = e.currentTarget.dataset.key;
                    const assignmentId = e.currentTarget.dataset.assignmentId;
                    handleRevertRemedialGrade(key, assignmentId);
                });
            });

            contentDiv.scrollTop = scrollPosition;

            const modal = document.getElementById('failedStudentDetailModal');
            if (modal.classList.contains('hidden')) {
                openModal(modal);
            }
        };


        // --- HANDLERS FOR NEW BUTTONS ---
        const handleEditYear = () => {
            const currentYear = state.currentAcademicYear;
            openInputModal({
                title: 'แก้ไขปีการศึกษา',
                defaultValue: currentYear,
                onConfirm: (newYearStr) => {
                    const newYear = parseInt(newYearStr);
                    if (newYear && newYear !== currentYear && !state.academicYears.some(y => y.year === newYear)) {
                        commitChange(() => {
                            const yearData = getCurrentAcademicYearData();
                            yearData.year = newYear;
                            state.currentAcademicYear = newYear;
                            state.academicYears.sort((a,b) => a.year - b.year);
                        });
                    } else {
                        showToast('ปีการศึกษาไม่ถูกต้องหรือซ้ำซ้อน', true);
                    }
                }
            });
        };

        const handleDeleteYear = () => {
            if (state.academicYears.length <= 1) {
                showToast('ไม่สามารถลบปีการศึกษาสุดท้ายได้', true);
                return;
            }
            const yearToDelete = state.currentAcademicYear;
            openInputModal({
                title: `ยืนยันการลบปีการศึกษา ${yearToDelete}`,
                description: 'การดำเนินการนี้จะลบข้อมูลทั้งหมดของปีการศึกษานี้อย่างถาวร พิมพ์ "ลบ" เพื่อยืนยัน',
                placeholder: 'พิมพ์ "ลบ"',
                onConfirm: (confirmation) => {
                    if (confirmation === 'ลบ') {
                        commitChange(() => {
                            state.academicYears = state.academicYears.filter(y => y.year !== yearToDelete);
                            state.currentAcademicYear = state.academicYears[0].year;
                            state.currentSemesterId = state.academicYears[0].semesters[0].id;
                        });
                    }
                }
            });
        };

        const handleEditSemester = () => {
            const yearData = getCurrentAcademicYearData();
            const semesterData = getCurrentSemesterData();
            openInputModal({
                title: 'แก้ไขชื่อภาคเรียน',
                defaultValue: semesterData.name.replace('ภาคเรียนที่ ', ''), // Show only number/text
                onConfirm: (name) => {
                    const trimmedName = name.trim();
                    if (trimmedName) {
                        let finalName = trimmedName;
                        if (!isNaN(trimmedName) && !isNaN(parseFloat(trimmedName))) {
                            finalName = `ภาคเรียนที่ ${trimmedName}`;
                        }
                        if (finalName !== semesterData.name && !yearData.semesters.some(s => s.name === finalName)) {
                             commitChange(() => {
                                getCurrentSemesterData().name = finalName;
                            });
                        } else {
                            showToast('ชื่อภาคเรียนไม่ถูกต้องหรือซ้ำซ้อน', true);
                        }
                    }
                }
            });
        };

        const handleDeleteSemester = () => {
            const yearData = getCurrentAcademicYearData();
            if (yearData.semesters.length <= 1) {
                showToast('ไม่สามารถลบภาคเรียนสุดท้ายได้', true);
                return;
            }
            const semesterToDelete = getCurrentSemesterData();
            openInputModal({
                title: `ยืนยันการลบภาคเรียน "${semesterToDelete.name}"`,
                description: 'การดำเนินการนี้จะลบข้อมูลทั้งหมดของภาคเรียนนี้อย่างถาวร พิมพ์ "ลบ" เพื่อยืนยัน',
                placeholder: 'พิมพ์ "ลบ"',
                onConfirm: (confirmation) => {
                    if (confirmation === 'ลบ') {
                        commitChange(() => {
                            const yearData = getCurrentAcademicYearData();
                            yearData.semesters = yearData.semesters.filter(s => s.id !== semesterToDelete.id);
                            state.currentSemesterId = yearData.semesters[0].id;
                        });
                    }
                }
            });
        };

        const handleResolveStudent = (key) => {
            commitChange(() => {
                const studentData = state.failedStudentWarehouse[key];
                if (studentData) {
                    state.resolvedFailedStudents[key] = studentData;
                    delete state.failedStudentWarehouse[key];
                }
            });
        };

        const handleUnresolveStudent = (key) => {
             commitChange(() => {
                const studentData = state.resolvedFailedStudents[key];
                if (studentData) {
                    state.failedStudentWarehouse[key] = studentData;
                    delete state.resolvedFailedStudents[key];
                }
            });
        };

        // --- INITIALIZATION ---
        undoBtn.addEventListener('click', handleUndo);
        redoBtn.addEventListener('click', handleRedo);
        addStudentBtn.addEventListener('click', handleAddStudent);
        addAssignmentBtn.addEventListener('click', handleAddAssignment);
        addSpecialColumnBtn.addEventListener('click', handleAddSpecialColumn);
        viewSummaryBtn.addEventListener('click', handleViewSummary);
        clearDataBtn.addEventListener('click', handleClearData);
        deleteClassBtn.addEventListener('click', handleDeleteClass);
        exportDashboardBtn.addEventListener('click', handleExportDashboard);
        searchInput.addEventListener('keyup', handleSearch);

        dashboardBtn.addEventListener('click', () => {
            currentView = currentView === 'gradebook' ? 'dashboard' : 'gradebook';
            state.currentStudentIdForReport = null;
            render();
        });
        
        document.getElementById('viewStudentReportBtn').addEventListener('click', () => {
            const studentId = parseInt(document.getElementById('studentGradeModalTitle').dataset.studentId);
            if (studentId) {
                handleViewStudentReport(studentId);
            }
        });

        assignmentScoreInput.addEventListener('change', (e) => {
            commitChange(() => {
                const classData = getCurrentClassData();
                if(classData) {
                    let value = parseInt(e.target.value);
                    if (isNaN(value) || value < 0) value = 0;
                    if (!classData.scoreConfig) {
                         classData.scoreConfig = { assignment: 50, midterm: 20, final: 30, midYear: 0, yearEnd: 0 };
                    }
                    classData.scoreConfig.assignment = value;
                }
            });
        });
        
        exportBtn.addEventListener('click', handleExport);
        importBtn.addEventListener('click', () => importFile.click());
        importFile.addEventListener('change', handleImport);
        customImportBtn.addEventListener('click', () => customImportFile.click());
        customImportFile.addEventListener('change', handleCustomImport);
        
        addEditListeners(mainTitle, () => openInputModal({
            title: 'แก้ไขหัวข้อหลัก',
            defaultValue: state.mainTitle,
            onConfirm: (newTitle) => { if (newTitle.trim()) { commitChange(() => { state.mainTitle = newTitle.trim(); }); } }
        }));

        document.querySelectorAll('#columnToggleContainer .toggle-column-btn:not(.special-toggle)').forEach(btn => {
            btn.addEventListener('click', handleToggleColumn);
        });
        
        allModals.forEach(modal => {
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(modal); });
            const closeButton = modal.querySelector('button[id^="close"], button[id$="CancelBtn"]');
            if (closeButton) {
                closeButton.addEventListener('click', () => closeModal(modal));
            }
        });
        
        settingsBtn.addEventListener('click', () => openModal(settingsModal));

        document.querySelectorAll('.status-btn').forEach(btn => btn.addEventListener('click', (e) => handleStatusUpdate(e.target.dataset.status)));
        
        document.getElementById('modalProgressScore').addEventListener('change', (e) => {
            handleProgressScoreUpdate(e.target.value);
        });

        document.getElementById('inputModalConfirmBtn').addEventListener('click', () => {
            let value = (currentInputType === 'textarea') ? document.getElementById('inputModalTextarea').value : document.getElementById('inputModalField').value;
            if (onInputConfirm) {
                onInputConfirm(value);
                onInputConfirm = null;
            }
            closeModal(document.getElementById('inputModal'));
        });
        document.getElementById('assignmentModalConfirmBtn').addEventListener('click', () => {
            const data = {
                name: document.getElementById('assignmentName').value,
                chapter: document.getElementById('assignmentChapter').value,
                assignedDate: document.getElementById('assignmentDate').value,
                daysToSubmit: parseInt(document.getElementById('daysToSubmit').value) || 7,
                quantity: document.getElementById('assignmentQuantity').value,
                page: document.getElementById('assignmentPage').value,
                weight: parseFloat(document.getElementById('assignmentWeight').value) || 1,
            };
            if (onAssignmentConfirm) {
                onAssignmentConfirm(data);
                onAssignmentConfirm = null;
            }
            closeModal(document.getElementById('assignmentModal'));
        });
        
        document.getElementById('bulkGradeFilter').addEventListener('change', () => {
            const assignmentId = parseInt(document.getElementById('bulkGradeModalTitle').dataset.assignmentId);
            renderBulkGradeModal(assignmentId);
        });
        document.getElementById('studentGradeFilter').addEventListener('change', () => {
            const studentId = parseInt(document.getElementById('studentGradeModalTitle').dataset.studentId);
            renderStudentGradeModal(studentId);
        });
        
        document.querySelectorAll('.collapse-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const panel = e.currentTarget.closest('[id$="Panel"]');
                if (panel) {
                    commitChange(() => {
                        state.panelVisibility[panel.id] = !state.panelVisibility[panel.id];
                    });
                }
            });
        });

        document.getElementById('sortAssignmentsDefault').addEventListener('click', () => { commitChange(() => { state.sortConfig.assignmentSort = 'default'; }); });
        document.getElementById('sortAssignmentsAsc').addEventListener('click', () => { commitChange(() => { state.sortConfig.assignmentSort = 'asc'; }); });
        document.getElementById('sortAssignmentsDesc').addEventListener('click', () => { commitChange(() => { state.sortConfig.assignmentSort = 'desc'; }); });

        // New Year/Semester Management Listeners
        document.getElementById('addYearBtn').addEventListener('click', () => {
            const currentThaiYear = new Date().getFullYear() + 543;
            openInputModal({
                title: 'เพิ่มปีการศึกษาใหม่',
                description: 'กรุณากรอกปีการศึกษา (พ.ศ.)',
                defaultValue: currentThaiYear + 1,
                onConfirm: (yearStr) => {
                    const year = parseInt(yearStr);
                    if (year && !state.academicYears.some(y => y.year === year)) {
                        commitChange(() => {
                            state.academicYears.push(getNewYearData(year));
                            state.academicYears.sort((a,b) => a.year - b.year);
                        });
                    } else {
                        showToast('ปีการศึกษาไม่ถูกต้องหรือมีอยู่แล้ว', true);
                    }
                }
            });
        });

        document.getElementById('addSemesterBtn').addEventListener('click', () => {
            openInputModal({
                title: 'เพิ่มภาคเรียนใหม่',
                description: `เพิ่มภาคเรียนสำหรับปีการศึกษา ${state.currentAcademicYear}`,
                placeholder: 'เช่น 1, 2',
                onConfirm: (name) => {
                    const trimmedName = name.trim();
                    if (trimmedName) {
                        let finalName = trimmedName;
                        if (!isNaN(trimmedName) && !isNaN(parseFloat(trimmedName))) {
                            finalName = `ภาคเรียนที่ ${trimmedName}`;
                        }
                        commitChange(() => {
                            const yearData = getCurrentAcademicYearData();
                            if (yearData.semesters.some(s => s.name === finalName)) {
                                showToast(`ภาคเรียน "${finalName}" มีอยู่แล้ว`, true);
                            } else {
                                yearData.semesters.push(getNewSemesterData(finalName));
                            }
                        });
                    }
                }
            });
        });
        
        document.getElementById('linkSemestersCheckbox').addEventListener('change', (e) => {
            commitChange(() => {
                const classData = getCurrentClassData();
                if (classData) {
                    if (!classData.settings) {
                        classData.settings = {};
                    }
                    classData.settings.linkSemesters = e.target.checked;
                }
            });
        });

        document.getElementById('warehouseToggle').addEventListener('click', (e) => {
            if (e.target.id === 'toggleFailed') {
                currentWarehouseView = 'failed';
                renderWarehouseView();
            } else if (e.target.id === 'toggleResolved') {
                currentWarehouseView = 'resolved';
                renderWarehouseView();
            }
        });


        setupFirestoreListener();
    });
</script>

</body>
</html>
